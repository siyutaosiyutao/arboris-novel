# 🤖 AI功能分类方案 - 最终版

**日期**: 2025-10-30  
**原则**: 按照"同一次AI调用 = 同一个功能"的原则进行分类  
**目的**: 精确识别每个独立的AI调用点,便于独立配置、监控和优化

---

## 📊 AI功能全景图（按实际调用分类）

### 1️⃣ **概念对话生成（Concept Conversation）**
**调用位置**: `novels.py::converse_with_concept()`  
**提示词**: `concept.md`  
**调用方式**: 
```python
llm_service.get_llm_response(
    system_prompt=concept_prompt,
    conversation_history=[...多轮对话历史...],
    temperature=0.8,
    timeout=240.0
)
```

**输入**: 
- 用户多轮对话历史
- 用户当前输入

**输出**: JSON格式的对话响应（包含问题、建议、已收集信息）

**特点**:
- 多轮对话式交互
- 引导用户完善创意
- 高创造性（temperature=0.8）
- 不直接生成蓝图

---

### 2️⃣ **蓝图生成（Blueprint Generation）**
**调用位置**: `novels.py::generate_blueprint()`  
**提示词**: `screenwriting.md`  
**调用方式**:
```python
llm_service.get_llm_response(
    system_prompt=screenwriting_prompt,
    conversation_history=[...完整对话历史...],
    temperature=0.3,
    timeout=300.0
)
```

**输入**: 
- 完整的概念对话历史

**输出**: 完整的Blueprint JSON（标题、风格、世界观、角色、大纲）

**特点**:
- 一次性生成完整设定
- 基于对话历史整理
- 较低temperature（0.3）确保结构化
- 生成后写入数据库

---

### 3️⃣ **批量大纲生成（Outline Batch Generation）**
**调用位置**: 
- `writer.py::generate_outlines()`
- `auto_generator_service._auto_generate_outlines()`

**提示词**: `outline.md`  
**调用方式**:
```python
llm_service.get_llm_response(
    system_prompt=outline_prompt,
    conversation_history=[{"role": "user", "content": json.dumps(payload)}],
    temperature=0.7,
    timeout=360.0
)
```

**输入**:
```json
{
  "novel_blueprint": {...},
  "completed_chapters": [...已完成章节摘要...],
  "wait_to_generate": {
    "start_chapter": 1,
    "num_chapters": 10
  }
}
```

**输出**: 
```json
{
  "chapters": [
    {"chapter_number": 1, "title": "...", "summary": "..."},
    ...
  ]
}
```

**特点**:
- 批量生成（通常10章）
- 参考已完成章节
- 确保剧情连贯
- 中等创造性（temperature=0.7）

---

### 4️⃣ **章节正文生成（Chapter Content Writing）**
**调用位置**: 
- `writer.py::generate_chapter()`
- `auto_generator_service._generate_chapter_content()`

**提示词**: `writing.md` 或 `screenwriting.md`  
**调用方式**:
```python
# 通常生成2个版本
for idx in range(version_count):
    llm_service.get_llm_response(
        system_prompt=writer_prompt,
        conversation_history=[{"role": "user", "content": prompt_input}],
        temperature=0.9,
        timeout=600.0
    )
```

**输入**:
- Blueprint（世界观、角色）
- 上一章摘要
- 上一章结尾片段
- RAG检索的剧情上下文
- RAG检索的章节摘要
- 当前章节大纲（标题+摘要+写作要求）

**输出**: 
```json
{
  "title": "章节标题",
  "summary": "章节摘要",
  "full_content": "完整正文（4500字以上）"
}
```

**特点**:
- **最高创造性**（temperature=0.9）
- **最长超时**（600秒）
- 支持多版本生成（通常2个）
- 支持RAG增强
- 可选剧本格式

---

### 5️⃣ **章节摘要提取（Summary Extraction）**
**调用位置**: 
- `llm_service.get_summary()`
- `auto_generator_service` 中自动调用

**提示词**: `extraction.md`  
**调用方式**:
```python
llm_service.get_summary(
    chapter_content=content,
    temperature=0.15,
    timeout=180.0
)
```

**输入**: 章节完整正文

**输出**: Markdown格式的结构化摘要（500字以内）
```markdown
### 1. 核心情节
...
### 2. 角色动态
...
### 3. 关键要素
...
### 4. 设定与伏笔
...
```

**特点**:
- **最低temperature**（0.15-0.2）
- 快速执行（180秒）
- 结构化输出
- 用于后续大纲生成和RAG

---

### 6️⃣ **基础分析（Basic Analysis）**
**调用位置**: `super_analysis_service._basic_analysis()`  
**提示词**: 内嵌在代码中  
**调用方式**:
```python
llm_service.get_llm_response(
    system_prompt="你是专业的小说分析专家。",
    conversation_history=[{"role": "user", "content": prompt}],
    temperature=0.3,
    timeout=180.0
)
```

**输入**: 章节正文

**输出**:
```json
{
  "summary": "章节摘要",
  "key_events": ["事件1", "事件2", "事件3"]
}
```

**特点**:
- **必须成功**（失败返回默认值）
- 结构简单
- 快速执行
- 为增强分析提供基础

---

### 7️⃣ **增强分析（Enhanced Analysis）**
**调用位置**: `super_analysis_service._enhanced_analysis()`  
**提示词**: 内嵌在代码中  
**调用方式**:
```python
llm_service.get_llm_response(
    system_prompt="你是专业的小说分析专家，擅长角色追踪和世界观分析。",
    conversation_history=[{"role": "user", "content": prompt}],
    temperature=0.3,
    timeout=600.0
)
```

**输入**:
- 章节正文
- Blueprint（用于对比）

**输出**:
```json
{
  "character_changes": [
    {
      "character_name": "张三",
      "change_type": "性格变化",
      "description": "...",
      "significance": "high"
    }
  ],
  "new_characters": [...],
  "world_extensions": {
    "new_locations": [...],
    "new_rules": [...],
    "new_factions": [...]
  },
  "foreshadowings": [
    {
      "content": "伏笔内容",
      "type": "剧情伏笔",
      "confidence": 0.85
    }
  ],
  "emotional_arcs": [...]
}
```

**特点**:
- **可选功能**（失败不影响主流程）
- 深度分析
- 长超时（600秒）
- 用于剧情指标计算

---

### 8️⃣ **章节评估（Chapter Evaluation）**
**调用位置**: `writer.py::evaluate_chapter()`  
**提示词**: `evaluation.md`  
**调用方式**:
```python
llm_service.get_llm_response(
    system_prompt=evaluator_prompt,
    conversation_history=[{"role": "user", "content": json.dumps(payload)}],
    temperature=0.3,
    timeout=360.0
)
```

**输入**:
```json
{
  "novel_blueprint": {...},
  "content_to_evaluate": {
    "chapter_number": 1,
    "versions": [
      {"version_id": 1, "content": "..."},
      {"version_id": 2, "content": "..."}
    ]
  }
}
```

**输出**: 评估报告（包含各版本评分、优缺点、推荐版本）

**特点**:
- 质量控制
- 多版本对比
- 客观评分
- 可用于自动选择最佳版本

---

### 9️⃣ **向量嵌入（Text Embedding）**
**调用位置**: 
- `chapter_ingest_service.ingest_chapter()` - 章节入库
- `chapter_context_service.retrieve_for_generation()` - 检索查询

**提示词**: 无（非生成式）  
**调用方式**:
```python
llm_service.get_embedding(
    text=chunk_text,
    user_id=user_id
)
```

**输入**: 文本片段（章节片段或查询文本）

**输出**: 向量数组（float list）

**特点**:
- **非生成式**
- 用于语义检索
- 支持多模型（OpenAI/Ollama）
- 支持多provider

**使用场景**:
1. 章节入库时：为每个chunk生成embedding
2. RAG检索时：为查询文本生成embedding

---

### 🔟 **卷名生成（Volume Naming）** 🆕
**调用位置**: `volume_split_service._generate_volume_title()`  
**提示词**: 内嵌在代码中  
**调用方式**:
```python
llm_service.run(
    task_name="volume_naming",
    prompt=prompt,
    model="deepseek-chat",
    timeout=30
)
```

**输入**:
- 卷号
- 章节范围
- 重大事件摘要
- 剧情指标

**输出**: 卷名（如"卷五·星陨之夜"）

**特点**:
- 创意性高
- 一次性调用
- 有fallback策略（AI失败时用默认格式）
- 快速执行（30秒）

---

## 📈 功能统计总结

| 功能ID | 功能名称 | Prompt文件 | Temperature | Timeout | 调用频率 | 优先级 |
|--------|---------|-----------|-------------|---------|---------|--------|
| F01 | 概念对话生成 | concept.md | 0.8 | 240s | 高 | 重要 |
| F02 | 蓝图生成 | screenwriting.md | 0.3 | 300s | 低 | 重要 |
| F03 | 批量大纲生成 | outline.md | 0.7 | 360s | 中 | 重要 |
| F04 | 章节正文生成 | writing.md | 0.9 | 600s | 极高 | 核心 |
| F05 | 章节摘要提取 | extraction.md | 0.15 | 180s | 极高 | 核心 |
| F06 | 基础分析 | 内嵌 | 0.3 | 180s | 高 | 核心 |
| F07 | 增强分析 | 内嵌 | 0.3 | 600s | 高 | 可选 |
| F08 | 章节评估 | evaluation.md | 0.3 | 360s | 中 | 可选 |
| F09 | 向量嵌入 | N/A | N/A | 60s | 极高 | 重要 |
| F10 | 卷名生成 | 内嵌 | 0.7 | 30s | 极低 | 可选 |

**总计**: 10个独立AI功能

---

## 🎯 关键发现

### 1. 没有重复调用
✅ 每个功能都是独立的一次AI调用  
✅ 没有"同一次调用生成多个结果"的情况  
✅ 章节正文生成虽然循环2次,但每次都是独立调用

### 2. 调用链路清晰
```
用户创建项目
  → F01: 概念对话（多轮）
  → F02: 蓝图生成（一次）
  → F03: 批量大纲生成（每10章一次）
  → F04: 章节正文生成（每章2次）
  → F05: 章节摘要提取（每章1次）
  → F06: 基础分析（每章1次）
  → F07: 增强分析（每章1次，可选）
  → F08: 章节评估（手动触发）
  → F10: 卷名生成（自动分卷时）
  
F09: 向量嵌入（贯穿全流程）
  - 章节入库时：每个chunk一次
  - RAG检索时：每次查询一次
```

### 3. 成本分布
**高成本**（长文本+高temperature）:
- F04: 章节正文生成（600s, temp=0.9）
- F07: 增强分析（600s, 复杂JSON）

**中成本**:
- F03: 批量大纲生成（360s, 10章）
- F08: 章节评估（360s, 多版本对比）
- F02: 蓝图生成（300s, 完整设定）

**低成本**:
- F05: 章节摘要提取（180s, temp=0.15）
- F06: 基础分析（180s, 简单JSON）
- F01: 概念对话（240s, 但单次输出少）
- F10: 卷名生成（30s, 极短）
- F09: 向量嵌入（非生成式）

---

## 💡 优化建议

### 1. 按成本分层配置模型
```python
# 高成本功能 - 用最强模型
F04_章节正文生成: "gpt-4o" / "claude-3-opus"

# 中成本功能 - 用平衡模型  
F03_大纲生成: "deepseek-chat" / "claude-3-sonnet"
F02_蓝图生成: "gpt-4o-mini" / "claude-3-sonnet"

# 低成本功能 - 用快速模型
F05_摘要提取: "gemini-1.5-flash" / "gpt-4o-mini"
F06_基础分析: "gemini-1.5-flash" / "gpt-4o-mini"
F10_卷名生成: "deepseek-chat"

# 可选功能 - 可降级
F07_增强分析: "gpt-4o" (失败可跳过)
F08_章节评估: "claude-3-sonnet" (手动触发)
```

### 2. 异步执行策略
```python
# 同步执行（阻塞）
F04: 章节正文生成 ✅
F05: 章节摘要提取 ✅
F06: 基础分析 ✅

# 异步执行（后台）
F07: 增强分析 ⚡
F09: 向量嵌入（入库） ⚡
```

### 3. 监控指标
为每个功能独立追踪:
- 调用次数
- 成功率
- 平均耗时
- Token消耗
- 成本估算
- 失败原因分类

---

## 🔧 技术实现方案

### 1. 创建AI功能枚举

```python
# app/schemas/ai_function.py

from enum import Enum
from typing import Optional

class AIFunctionType(str, Enum):
    """AI功能类型枚举（按实际调用分类）"""

    # 概念与规划阶段
    CONCEPT_CONVERSATION = "concept_conversation"      # F01: 概念对话
    BLUEPRINT_GENERATION = "blueprint_generation"      # F02: 蓝图生成
    OUTLINE_BATCH_GENERATION = "outline_batch_generation"  # F03: 批量大纲生成

    # 章节创作阶段
    CHAPTER_CONTENT_WRITING = "chapter_content_writing"  # F04: 章节正文生成
    SUMMARY_EXTRACTION = "summary_extraction"          # F05: 章节摘要提取

    # 分析阶段
    BASIC_ANALYSIS = "basic_analysis"                  # F06: 基础分析
    ENHANCED_ANALYSIS = "enhanced_analysis"            # F07: 增强分析

    # 评估与优化
    CHAPTER_EVALUATION = "chapter_evaluation"          # F08: 章节评估

    # 基础设施
    TEXT_EMBEDDING = "text_embedding"                  # F09: 向量嵌入

    # 自动化功能
    VOLUME_NAMING = "volume_naming"                    # F10: 卷名生成


class AIFunctionPriority(str, Enum):
    """AI功能优先级"""
    CRITICAL = "critical"    # 核心功能，必须成功
    IMPORTANT = "important"  # 重要功能，失败需重试
    OPTIONAL = "optional"    # 可选功能，失败可忽略


class AIFunctionCategory(str, Enum):
    """AI功能分类（用于分组展示）"""
    CONCEPT_PLANNING = "concept_planning"      # 概念与规划
    CONTENT_CREATION = "content_creation"      # 内容创作
    ANALYSIS = "analysis"                      # 分析
    QUALITY_CONTROL = "quality_control"        # 质量控制
    INFRASTRUCTURE = "infrastructure"          # 基础设施
    AUTOMATION = "automation"                  # 自动化


# 功能配置映射
AI_FUNCTION_CONFIG = {
    AIFunctionType.CONCEPT_CONVERSATION: {
        "name": "概念对话生成",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "concept",
        "temperature": 0.8,
        "timeout": 240,
        "max_retries": 2,
        "recommended_model": "claude-3-opus",
        "fallback_model": "gpt-4o",
        "description": "引导用户完善小说创意的多轮对话",
    },
    AIFunctionType.BLUEPRINT_GENERATION: {
        "name": "蓝图生成",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "screenwriting",
        "temperature": 0.3,
        "timeout": 300,
        "max_retries": 3,
        "recommended_model": "gpt-4o-mini",
        "fallback_model": "claude-3-sonnet",
        "description": "基于对话历史生成完整的小说蓝图",
    },
    AIFunctionType.OUTLINE_BATCH_GENERATION: {
        "name": "批量大纲生成",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "outline",
        "temperature": 0.7,
        "timeout": 360,
        "max_retries": 3,
        "recommended_model": "deepseek-chat",
        "fallback_model": "gpt-4o-mini",
        "description": "批量生成章节大纲（通常10章）",
    },
    AIFunctionType.CHAPTER_CONTENT_WRITING: {
        "name": "章节正文生成",
        "category": AIFunctionCategory.CONTENT_CREATION,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": "writing",
        "temperature": 0.9,
        "timeout": 600,
        "max_retries": 3,
        "recommended_model": "gpt-4o",
        "fallback_model": "claude-3-sonnet",
        "description": "生成章节完整正文（4500字以上）",
        "cost_level": "high",
    },
    AIFunctionType.SUMMARY_EXTRACTION: {
        "name": "章节摘要提取",
        "category": AIFunctionCategory.CONTENT_CREATION,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": "extraction",
        "temperature": 0.15,
        "timeout": 180,
        "max_retries": 2,
        "recommended_model": "gemini-1.5-flash",
        "fallback_model": "gpt-4o-mini",
        "description": "提取章节结构化摘要（500字以内）",
        "cost_level": "low",
    },
    AIFunctionType.BASIC_ANALYSIS: {
        "name": "基础分析",
        "category": AIFunctionCategory.ANALYSIS,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": None,  # 内嵌
        "temperature": 0.3,
        "timeout": 180,
        "max_retries": 2,
        "recommended_model": "gemini-1.5-flash",
        "fallback_model": "gpt-4o-mini",
        "description": "提取章节摘要和关键事件",
        "cost_level": "low",
    },
    AIFunctionType.ENHANCED_ANALYSIS: {
        "name": "增强分析",
        "category": AIFunctionCategory.ANALYSIS,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": None,  # 内嵌
        "temperature": 0.3,
        "timeout": 600,
        "max_retries": 1,
        "recommended_model": "gpt-4o",
        "fallback_model": None,  # 失败可跳过
        "description": "深度分析角色、世界观、伏笔等",
        "cost_level": "high",
        "async_mode": True,
    },
    AIFunctionType.CHAPTER_EVALUATION: {
        "name": "章节评估",
        "category": AIFunctionCategory.QUALITY_CONTROL,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": "evaluation",
        "temperature": 0.3,
        "timeout": 360,
        "max_retries": 1,
        "recommended_model": "claude-3-sonnet",
        "fallback_model": "gpt-4o-mini",
        "description": "评估章节质量并给出改进建议",
        "cost_level": "medium",
    },
    AIFunctionType.TEXT_EMBEDDING: {
        "name": "向量嵌入",
        "category": AIFunctionCategory.INFRASTRUCTURE,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": None,
        "temperature": None,
        "timeout": 60,
        "max_retries": 2,
        "recommended_model": "text-embedding-3-large",
        "fallback_model": "nomic-embed-text",
        "description": "生成文本向量用于RAG检索",
        "cost_level": "low",
    },
    AIFunctionType.VOLUME_NAMING: {
        "name": "卷名生成",
        "category": AIFunctionCategory.AUTOMATION,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": None,  # 内嵌
        "temperature": 0.7,
        "timeout": 30,
        "max_retries": 1,
        "recommended_model": "deepseek-chat",
        "fallback_model": None,  # 有默认命名策略
        "description": "根据剧情高潮生成卷名",
        "cost_level": "low",
    },
}
```

### 2. 数据库表设计

```sql
-- AI功能配置表
CREATE TABLE ai_function_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    function_type VARCHAR(50) NOT NULL UNIQUE,
    enabled BOOLEAN DEFAULT TRUE,
    priority VARCHAR(20) NOT NULL,
    temperature FLOAT,
    timeout INTEGER,
    max_retries INTEGER,
    model_override VARCHAR(100),  -- 可覆盖推荐模型
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户级别的功能访问控制
CREATE TABLE user_ai_function_access (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    function_type VARCHAR(50) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    daily_quota INTEGER,  -- 每日配额（NULL=无限制）
    quota_used INTEGER DEFAULT 0,
    quota_reset_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, function_type)
);

-- AI功能调用日志
CREATE TABLE ai_function_call_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    function_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- success/failure/timeout
    duration_ms INTEGER,
    input_tokens INTEGER,
    output_tokens INTEGER,
    cost_usd DECIMAL(10, 6),
    model_used VARCHAR(100),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建索引
CREATE INDEX idx_call_logs_user_function ON ai_function_call_logs(user_id, function_type);
CREATE INDEX idx_call_logs_created_at ON ai_function_call_logs(created_at);
CREATE INDEX idx_user_access_user_function ON user_ai_function_access(user_id, function_type);
```

---

## 📝 下一步行动

1. ✅ **确认分类** - 10个功能已全部识别
2. ✅ **创建枚举** - AIFunctionType枚举已设计
3. ⏭️ **数据库迁移** - 创建配置和日志表
4. ⏭️ **统一调用接口** - 创建AIOrchestrator
5. ⏭️ **监控接入** - 添加Prometheus指标
6. ⏭️ **成本优化** - 按功能分配不同模型


