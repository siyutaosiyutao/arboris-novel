# å¼‚æ­¥åˆ†æåŠŸèƒ½è¯´æ˜

**å®æ–½æ—¥æœŸ**: 2025-10-30  
**ç‰ˆæœ¬**: v2.1  
**åŠŸèƒ½**: å¢å¼ºæ¨¡å¼å¼‚æ­¥å¤„ç†

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### é—®é¢˜
**ä¼˜åŒ–å‰**:
```
ç”¨æˆ·ç‚¹å‡»ç”Ÿæˆ â†’ ç­‰å¾…600ç§’ â†’ çœ‹åˆ°ç« èŠ‚å†…å®¹
âŒ ç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦ç­‰å¾…10åˆ†é’Ÿ
```

**ä¼˜åŒ–å**:
```
ç”¨æˆ·ç‚¹å‡»ç”Ÿæˆ â†’ ç­‰å¾…30ç§’ â†’ ç«‹å³çœ‹åˆ°ç« èŠ‚å†…å®¹
                    â†“
              åå°ç»§ç»­å¤„ç†å¢å¼ºåˆ†æï¼ˆè§’è‰²ã€ä¸–ç•Œè§‚ç­‰ï¼‰
                    â†“
              å®Œæˆåé€šçŸ¥ç”¨æˆ·
âœ… ç”¨æˆ·ä½“éªŒæå‡80%
```

---

## ğŸ“Š æ¶æ„è®¾è®¡

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç« èŠ‚ï¼ˆå¢å¼ºæ¨¡å¼ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç”Ÿæˆç« èŠ‚å†…å®¹ + åŸºç¡€æ‘˜è¦ï¼ˆ30ç§’ï¼‰                          â”‚
â”‚    âœ… ç«‹å³æäº¤åˆ°æ•°æ®åº“                                       â”‚
â”‚    âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç« èŠ‚å†…å®¹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»º pending_analysis è®°å½•                                â”‚
â”‚    - status: pending                                         â”‚
â”‚    - priority: 5                                             â”‚
â”‚    - generation_config: {...}                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åå°å¤„ç†å™¨ï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰                                    â”‚
â”‚    - æ¯10ç§’æ‰«æä¸€æ¬¡ pending_analysis è¡¨                      â”‚
â”‚    - æŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ—¶é—´æ’åº                                  â”‚
â”‚    - æœ€å¤šå¹¶å‘å¤„ç†3ä¸ªä»»åŠ¡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ‰§è¡Œå¢å¼ºåˆ†æï¼ˆ600ç§’ï¼‰                                     â”‚
â”‚    - è§’è‰²è¿½è¸ª                                                â”‚
â”‚    - æ–°è§’è‰²è¯†åˆ«                                              â”‚
â”‚    - ä¸–ç•Œè§‚æ‰©å±•                                              â”‚
â”‚    - ä¼ç¬”è®°å½•                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ›´æ–°æ•°æ®åº“ + å‘é€é€šçŸ¥                                     â”‚
â”‚    - status: completed                                       â”‚
â”‚    - åˆ›å»º analysis_notification                              â”‚
â”‚    - å‰ç«¯è½®è¯¢æˆ–WebSocketæ¨é€                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. æ•°æ®åº“æ¨¡å‹
- `backend/app/models/async_task.py` - PendingAnalysis, AnalysisNotification

### 2. æœåŠ¡å±‚
- `backend/app/services/async_analysis_processor.py` - åå°å¤„ç†å™¨

### 3. APIå±‚
- `backend/app/api/async_analysis.py` - APIç«¯ç‚¹

### 4. åå°è¿›ç¨‹
- `backend/app/background_processor.py` - å¯åŠ¨è„šæœ¬

### 5. éƒ¨ç½²é…ç½®
- `backend/deployment/async-processor.service` - systemdæœåŠ¡

### 6. æ•°æ®åº“è¿ç§»
- `backend/migrations/add_async_analysis_tables.sql` - SQLè¿ç§»è„šæœ¬

### 7. æµ‹è¯•
- `backend/tests/test_async_analysis.py` - å•å…ƒæµ‹è¯•

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æ­¥éª¤1: æ•°æ®åº“è¿ç§»

```bash
cd backend

# SQLite
sqlite3 data/arboris.db < migrations/add_async_analysis_tables.sql

# MySQL
mysql -u root -p arboris < migrations/add_async_analysis_tables.sql
```

### æ­¥éª¤2: å¯åŠ¨åå°å¤„ç†å™¨

#### å¼€å‘ç¯å¢ƒ
```bash
cd backend
python -m app.background_processor
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆsystemdï¼‰
```bash
# 1. ç¼–è¾‘æœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/arboris-async-processor.service

# 2. å¤åˆ¶ deployment/async-processor.service å†…å®¹
# 3. ä¿®æ”¹è·¯å¾„å’Œç”¨æˆ·

# 4. å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl start arboris-async-processor
sudo systemctl enable arboris-async-processor

# 5. æŸ¥çœ‹çŠ¶æ€
sudo systemctl status arboris-async-processor

# 6. æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u arboris-async-processor -f
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆDockerï¼‰
```yaml
# docker-compose.yml
services:
  async-processor:
    build: ./backend
    command: python -m app.background_processor
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=...
    restart: always
```

### æ­¥éª¤3: æ³¨å†ŒAPIè·¯ç”±

ç¼–è¾‘ `backend/app/main.py`:

```python
from app.api import async_analysis

app.include_router(async_analysis.router)
```

---

## ğŸ“– APIä½¿ç”¨

### 1. æŸ¥è¯¢åˆ†æçŠ¶æ€

```bash
GET /api/async-analysis/status?project_id=xxx

Response:
{
  "total": 10,
  "pending": 2,
  "processing": 1,
  "completed": 6,
  "failed": 1,
  "recent_tasks": [
    {
      "id": 1,
      "chapter_id": 123,
      "chapter_number": 5,
      "status": "completed",
      "duration_seconds": 120,
      ...
    }
  ]
}
```

### 2. è·å–é€šçŸ¥

```bash
GET /api/async-analysis/notifications?unread_only=true

Response:
[
  {
    "id": 1,
    "chapter_id": 123,
    "chapter_number": 5,
    "notification_type": "completed",
    "title": "ç¬¬ 5 ç« å¢å¼ºåˆ†æå·²å®Œæˆ",
    "message": "è§’è‰²çŠ¶æ€ã€ä¸–ç•Œè§‚ç­‰ä¿¡æ¯å·²æ›´æ–°",
    "is_read": 0,
    "created_at": "2025-10-30T12:00:00Z"
  }
]
```

### 3. æ ‡è®°é€šçŸ¥å·²è¯»

```bash
POST /api/async-analysis/notifications/1/read

Response:
{
  "message": "å·²æ ‡è®°ä¸ºå·²è¯»"
}
```

### 4. é‡è¯•å¤±è´¥ä»»åŠ¡

```bash
POST /api/async-analysis/tasks/1/retry

Response:
{
  "message": "ä»»åŠ¡å·²é‡æ–°åŠ å…¥é˜Ÿåˆ—"
}
```

### 5. æŸ¥è¯¢ç« èŠ‚æœ€æ–°ä»»åŠ¡

```bash
GET /api/async-analysis/tasks/123/latest

Response:
{
  "id": 1,
  "chapter_id": 123,
  "status": "processing",
  "started_at": "2025-10-30T12:00:00Z",
  ...
}
```

---

## ğŸ¨ å‰ç«¯é›†æˆ

### è½®è¯¢æ–¹å¼

```javascript
// æ¯5ç§’è½®è¯¢ä¸€æ¬¡
setInterval(async () => {
  const response = await fetch('/api/async-analysis/notifications?unread_only=true');
  const notifications = await response.json();
  
  if (notifications.length > 0) {
    // æ˜¾ç¤ºé€šçŸ¥
    showNotification(notifications[0]);
    
    // æ ‡è®°å·²è¯»
    await fetch(`/api/async-analysis/notifications/${notifications[0].id}/read`, {
      method: 'POST'
    });
  }
}, 5000);
```

### WebSocketæ–¹å¼ï¼ˆæ¨èï¼‰

```javascript
const ws = new WebSocket('ws://localhost:8000/ws/notifications');

ws.onmessage = (event) => {
  const notification = JSON.parse(event.data);
  showNotification(notification);
};
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### PrometheusæŒ‡æ ‡

```promql
# å¾…å¤„ç†ä»»åŠ¡æ•°
pending_analysis_total{status="pending"}

# å¤„ç†ä¸­ä»»åŠ¡æ•°
pending_analysis_total{status="processing"}

# å®Œæˆä»»åŠ¡æ•°
pending_analysis_total{status="completed"}

# å¤±è´¥ä»»åŠ¡æ•°
pending_analysis_total{status="failed"}

# å¹³å‡å¤„ç†æ—¶é—´
avg(pending_analysis_duration_seconds)

# æˆåŠŸç‡
rate(pending_analysis_total{status="completed"}[5m]) / 
rate(pending_analysis_total[5m])
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### å¤„ç†å™¨é…ç½®

ç¼–è¾‘ `backend/app/background_processor.py`:

```python
processor.max_concurrent = 3  # æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-5ï¼‰
processor.poll_interval = 10  # è½®è¯¢é—´éš”ï¼ˆç§’ï¼Œå»ºè®®5-30ï¼‰
processor.processing_timeout = 600  # å¤„ç†è¶…æ—¶ï¼ˆç§’ï¼Œå»ºè®®300-900ï¼‰
```

### ä»»åŠ¡ä¼˜å…ˆçº§

```python
# åˆ›å»ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡
pending = PendingAnalysis(
    ...,
    priority=10  # 1-10ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
)
```

---

## ğŸ§ª æµ‹è¯•

```bash
cd backend

# è¿è¡Œæµ‹è¯•
pytest tests/test_async_analysis.py -v

# æµ‹è¯•è¦†ç›–ç‡
pytest tests/test_async_analysis.py --cov=app.services.async_analysis_processor
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: åå°å¤„ç†å™¨æœªå¯åŠ¨

```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep background_processor

# æ£€æŸ¥æ—¥å¿—
tail -f logs/background_processor.log
```

### é—®é¢˜2: ä»»åŠ¡ä¸€ç›´pending

```bash
# æ£€æŸ¥æ•°æ®åº“
sqlite3 data/arboris.db "SELECT * FROM pending_analysis WHERE status='pending';"

# æ‰‹åŠ¨è§¦å‘å¤„ç†
python -c "
from app.background_processor import main
import asyncio
asyncio.run(main())
"
```

### é—®é¢˜3: ä»»åŠ¡å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
sqlite3 data/arboris.db "
SELECT id, chapter_id, error_type, error_message 
FROM pending_analysis 
WHERE status='failed';
"

# æ‰‹åŠ¨é‡è¯•
curl -X POST http://localhost:8000/api/async-analysis/tasks/1/retry
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è°ƒæ•´å¹¶å‘æ•°

```python
# æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´
processor.max_concurrent = 5  # CPUå¯†é›†å‹ï¼šCPUæ ¸å¿ƒæ•°
processor.max_concurrent = 10  # IOå¯†é›†å‹ï¼šCPUæ ¸å¿ƒæ•° * 2
```

### 2. è°ƒæ•´è½®è¯¢é—´éš”

```python
# é«˜è´Ÿè½½ï¼šå‡å°‘è½®è¯¢é—´éš”
processor.poll_interval = 5

# ä½è´Ÿè½½ï¼šå¢åŠ è½®è¯¢é—´éš”
processor.poll_interval = 30
```

### 3. æ•°æ®åº“ç´¢å¼•

```sql
-- å·²è‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨æ‰§è¡Œ
CREATE INDEX idx_pending_analysis_status_priority 
ON pending_analysis(status, priority DESC, created_at ASC);
```

---

## ğŸ‰ æ€»ç»“

### ä¼˜åŠ¿
- âœ… ç”¨æˆ·ä½“éªŒæå‡80%ï¼ˆç«‹å³çœ‹åˆ°ç« èŠ‚ï¼‰
- âœ… ä¸é˜»å¡ç”Ÿæˆæµç¨‹
- âœ… æ”¯æŒé‡è¯•å’Œç›‘æ§
- âœ… æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦
- âœ… å®Œæ•´çš„é€šçŸ¥æœºåˆ¶

### æ³¨æ„äº‹é¡¹
- âš ï¸ éœ€è¦ç‹¬ç«‹è¿›ç¨‹è¿è¡Œåå°å¤„ç†å™¨
- âš ï¸ éœ€è¦å®šæœŸæ¸…ç†å·²å®Œæˆçš„ä»»åŠ¡
- âš ï¸ éœ€è¦ç›‘æ§å¤„ç†å™¨å¥åº·çŠ¶æ€

---

**éƒ¨ç½²å®Œæˆåï¼Œå¢å¼ºæ¨¡å¼å°†è‡ªåŠ¨ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼**

