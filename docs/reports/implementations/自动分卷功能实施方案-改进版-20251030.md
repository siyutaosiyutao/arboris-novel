# è‡ªåŠ¨åˆ†å·åŠŸèƒ½å®æ–½æ–¹æ¡ˆï¼ˆæ”¹è¿›ç‰ˆï¼‰

**æ—¥æœŸ**: 2025-10-30  
**çŠ¶æ€**: âœ… å·²å®ç°  
**ç‰ˆæœ¬**: v2.0ï¼ˆåŸºäºåŸæ–¹æ¡ˆæ”¹è¿›ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ€»ä½“æµç¨‹](#æ€»ä½“æµç¨‹)
2. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
3. [æŒ‡æ ‡èšåˆ](#æŒ‡æ ‡èšåˆ)
4. [åˆ†å·åˆ¤å®š](#åˆ†å·åˆ¤å®š)
5. [å·åç”Ÿæˆ](#å·åç”Ÿæˆ)
6. [é›†æˆç‚¹](#é›†æˆç‚¹)
7. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
8. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## 1. æ€»ä½“æµç¨‹

```mermaid
graph TD
    A[ç« èŠ‚ç”Ÿæˆå®Œæˆ] --> B[å¢å¼ºåˆ†æå®Œæˆ]
    B --> C[è®°å½•å‰§æƒ…æŒ‡æ ‡]
    C --> D[è¯„ä¼°åˆ†å·æ¡ä»¶]
    D --> E{æ»¡è¶³æ¡ä»¶?}
    E -->|æ˜¯| F[AIç”Ÿæˆå·å]
    E -->|å¦| Z[ç»“æŸ]
    F --> G[åˆ›å»ºæ–°å·]
    G --> H[æ›´æ–°ç« èŠ‚volume_id]
    H --> I[è®°å½•æ—¥å¿—]
    I --> Z
```

### è¯¦ç»†æ­¥éª¤

1. **ç« èŠ‚ç”Ÿæˆå®Œæˆ** - `AutoGeneratorService._process_enhanced_mode` æˆ–å¼‚æ­¥å¢å¼ºå¤„ç†å™¨æ”¶å°¾
2. **è®°å½•å‰§æƒ…æŒ‡æ ‡** - è§£æå¢å¼ºåˆ†æç»“æœ & æ‘˜è¦ â†’ å†™å…¥ `chapter_story_metrics`
3. **è¯„åˆ†åˆ¤å®š** - `VolumeSplitService.evaluate_project()` è¯»å–æœ€è¿‘ N ç« æŒ‡æ ‡
4. **å‘½ä¸­æ¡ä»¶** - åˆ›å»ºæ–°å·ã€æ›´æ–° `Chapter/ChapterOutline` çš„ `volume_id`
5. **AI å‘½å** - æ„é€ æç¤ºè¯ï¼ˆé™„æœ€è¿‘é‡å¤§äº‹ä»¶æ‘˜è¦ï¼‰è°ƒç”¨æŒ‡å®šæ¨¡å‹ç”Ÿæˆå·å
6. **æ—¥å¿—è®°å½•** - "è‡ªåŠ¨åˆ›å»ºå·äº”Â·æ˜Ÿé™¨ä¹‹å¤œï¼ˆç¬¬ 46-60 ç« ï¼Œè¯„åˆ† 72ï¼Œå¤§äº‹ä»¶ï¼šå®—é—¨è¦†ç­ï¼‰"

---

## 2. æ•°æ®æ¨¡å‹

### æ–°å¢è¡¨ï¼š`chapter_story_metrics`

```sql
CREATE TABLE chapter_story_metrics (
    id SERIAL PRIMARY KEY,
    project_id VARCHAR(36) NOT NULL,
    chapter_id BIGINT NOT NULL,
    chapter_number INT NOT NULL,
    
    -- åŸºç¡€æŒ‡æ ‡
    word_count INT DEFAULT 0,
    
    -- äº‹ä»¶æŒ‡æ ‡
    key_event_count INT DEFAULT 0,
    major_event_flag BOOLEAN DEFAULT FALSE,
    
    -- ä¼ç¬”æŒ‡æ ‡
    foreshadow_count INT DEFAULT 0,
    foreshadow_max_conf DOUBLE PRECISION DEFAULT 0,
    
    -- è§’è‰²ä¸ä¸–ç•Œè§‚
    character_breakthrough_flag BOOLEAN DEFAULT FALSE,
    world_shock_flag BOOLEAN DEFAULT FALSE,
    
    -- è¯„åˆ†
    climax_score INT DEFAULT 0,        -- é«˜æ½®è¯„åˆ†(0-100)
    stage_score INT DEFAULT 0,         -- ç»¼åˆè¯„åˆ†(0-100)
    
    -- åŸå§‹æ•°æ®å¿«ç…§
    metrics JSONB,
    
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    
    UNIQUE(project_id, chapter_number)
);
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `key_event_count` | INT | å…³é”®äº‹ä»¶æ•°é‡ |
| `major_event_flag` | BOOLEAN | æ˜¯å¦æœ‰é‡å¤§äº‹ä»¶ï¼ˆè§’è‰²çªç ´/é«˜æ½®ä¼ç¬”ï¼‰ |
| `foreshadow_count` | INT | ä¼ç¬”æ•°é‡ |
| `foreshadow_max_conf` | FLOAT | ä¼ç¬”æœ€é«˜ç½®ä¿¡åº¦ |
| `character_breakthrough_flag` | BOOLEAN | è§’è‰²æ˜¯å¦çªç ´ï¼ˆæˆé•¿ç­‰çº§>=5ï¼‰ |
| `world_shock_flag` | BOOLEAN | ä¸–ç•Œè§‚æ˜¯å¦éœ‡æ’¼ï¼ˆæœ‰æ–°å¢å…ƒç´ ï¼‰ |
| `climax_score` | INT | é«˜æ½®è¯„åˆ†ï¼ˆåŸºäºäº‹ä»¶å¯†åº¦å’Œç±»å‹ï¼‰ |
| `stage_score` | INT | ç»¼åˆé˜¶æ®µè¯„åˆ†ï¼ˆåŠ æƒè®¡ç®—ï¼‰ |
| `metrics` | JSONB | åŸå§‹æŒ‡æ ‡å¿«ç…§ï¼ˆç”¨äºè°ƒè¯•å’Œé‡ç®—ï¼‰ |

---

## 3. æŒ‡æ ‡èšåˆ

### æœåŠ¡ï¼š`StoryMetricsService`

#### æ ¸å¿ƒæ–¹æ³•

```python
class StoryMetricsService:
    @classmethod
    async def record_metrics(
        cls,
        db: AsyncSession,
        project_id: str,
        chapter_id: int,
        chapter_number: int,
        enhanced_result: dict,
        summary_result: dict,
        word_count: int,
        config: Optional[dict] = None
    ) -> dict:
        """è®°å½•ç« èŠ‚å‰§æƒ…æŒ‡æ ‡"""
```

#### è¯„åˆ†ç®—æ³•ï¼ˆæ”¹è¿›ç‰ˆï¼‰

```python
def _compute_stage_score(metrics: dict, weights: dict) -> int:
    score = 0.0
    
    # å…³é”®äº‹ä»¶ï¼ˆæ¯æ¡ +8åˆ†ï¼‰
    score += metrics["key_event_count"] * weights["key_event"]
    
    # ä¼ç¬”ï¼ˆæ¯æ¡ +5åˆ†ï¼Œç½®ä¿¡åº¦ * 10ï¼‰
    score += metrics["foreshadow_count"] * weights["foreshadow"]
    score += metrics["foreshadow_max_conf"] * weights["foreshadow_conf"]
    
    # è§’è‰²çªç ´ +20åˆ†
    if metrics["character_breakthrough_flag"]:
        score += weights["character_breakthrough"]
    
    # ä¸–ç•Œè§‚éœ‡æ’¼ +15åˆ†
    if metrics["world_shock_flag"]:
        score += weights["world_shock"]
    
    # é‡å¤§äº‹ä»¶ +25åˆ†
    if metrics["major_event_flag"]:
        score += weights["major_event"]
    
    # é«˜æ½®ç« èŠ‚åŠ æˆï¼ˆè¯„åˆ†>=70æ—¶ * 1.2ï¼‰
    if metrics["climax_score"] >= 70:
        score *= weights["climax_multiplier"]
    
    return min(int(score), 100)
```

#### é»˜è®¤æƒé‡

```python
DEFAULT_WEIGHTS = {
    "key_event": 8,
    "foreshadow": 5,
    "foreshadow_conf": 10,
    "character_breakthrough": 20,
    "world_shock": 15,
    "major_event": 25,
    "climax_multiplier": 1.2,
}
```

---

## 4. åˆ†å·åˆ¤å®š

### æœåŠ¡ï¼š`VolumeSplitService`

#### åˆ¤å®šé€»è¾‘

```python
async def evaluate_project(
    self,
    project_id: str,
    task_id: Optional[int] = None,
    config: Optional[dict] = None
) -> Optional[Volume]:
    """è¯„ä¼°é¡¹ç›®æ˜¯å¦éœ€è¦åˆ†å·"""
    
    # 1. æ£€æŸ¥æœ€å°ç« èŠ‚æ•°
    if chapters_since_last < config["min_chapters"]:
        return None
    
    # 2. å¼ºåˆ¶åˆ†å·ï¼ˆè¾¾åˆ°æœ€å¤§ç« èŠ‚æ•°ï¼‰
    if chapters_since_last >= config["max_chapters"]:
        return await self._create_volume(reason="è¾¾åˆ°æœ€å¤§ç« èŠ‚æ•°")
    
    # 3. æ£€æŸ¥å†·å´æœŸ
    if chapters_since_last < config["min_chapters"] + config["cooldown_chapters"]:
        return None
    
    # 4. åŠ è½½è¯„åˆ†çª—å£
    metrics_window = await self._load_metrics_window(
        window_size=config["window_size"]
    )
    
    # 5. è¯„åˆ†åˆ¤å®š
    avg_score = statistics.mean(m.stage_score for m in metrics_window)
    has_major_event = any(m.major_event_flag for m in metrics_window)
    max_score = max(m.stage_score for m in metrics_window)
    
    # 6. åˆ¤å®šæ˜¯å¦åˆ†å·
    should_split = (
        avg_score >= config["score_threshold"] or 
        has_major_event or
        max_score >= 80  # å•ç« é«˜åˆ†ä¹Ÿè§¦å‘
    )
    
    if should_split:
        return await self._create_volume(...)
```

#### è§¦å‘æ¡ä»¶ï¼ˆä¸‰é€‰ä¸€ï¼‰

1. **å¹³å‡è¯„åˆ†è¾¾æ ‡** - çª—å£å†…å¹³å‡ `stage_score` >= é˜ˆå€¼ï¼ˆé»˜è®¤60ï¼‰
2. **é‡å¤§äº‹ä»¶** - çª—å£å†…ä»»ä¸€ç« èŠ‚ `major_event_flag = true`
3. **å•ç« é«˜æ½®** - çª—å£å†…ä»»ä¸€ç« èŠ‚ `stage_score >= 80`

---

## 5. å·åç”Ÿæˆ

### AI æç¤ºè¯

```python
def _build_naming_prompt(
    volume_number: int,
    start_chapter: int,
    end_chapter: int,
    metrics_window: List[ChapterStoryMetrics]
) -> str:
    highlights = []
    for m in metrics_window:
        if m.major_event_flag:
            highlights.append(f"ç¬¬{m.chapter_number}ç« è§¦å‘é‡å¤§äº‹ä»¶ï¼ˆè¯„åˆ†{m.stage_score}ï¼‰")
    
    return f"""è¯·ä¸ºå°è¯´çš„ç¬¬{volume_number}å·ç”Ÿæˆä¸€ä¸ªå¯Œæœ‰è¯—æ„å’Œå¸å¼•åŠ›çš„å·åã€‚

**å·ä¿¡æ¯**:
- å·å·: ç¬¬{volume_number}å·
- ç« èŠ‚èŒƒå›´: ç¬¬{start_chapter}-{end_chapter}ç« 
- é‡å¤§äº‹ä»¶:
{highlights_text}

**è¦æ±‚**:
1. å·åæ ¼å¼: "å·{ä¸­æ–‡æ•°å­—}Â·<å‰¯æ ‡é¢˜>"
2. å‰¯æ ‡é¢˜åº”ç®€æ´æœ‰åŠ›ï¼Œ2-6ä¸ªå­—
3. ä½“ç°æœ¬å·çš„æ ¸å¿ƒå‰§æƒ…æˆ–ä¸»é¢˜
4. å¯Œæœ‰è¯—æ„å’Œæƒ³è±¡åŠ›
5. åªè¿”å›å·åï¼Œä¸è¦å…¶ä»–è§£é‡Š

**ç¤ºä¾‹**:
- å·ä¸€Â·åˆå…¥æ±Ÿæ¹–
- å·äºŒÂ·æ˜Ÿé™¨ä¹‹å¤œ
- å·ä¸‰Â·ç ´å¢ƒä¹‹è·¯

è¯·ç”Ÿæˆå·å:"""
```

### Fallback ç­–ç•¥

```python
# AI å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ ¼å¼
fallback_title = f"å·{ä¸­æ–‡æ•°å­—}Â·ç¬¬{start_chapter}-{end_chapter}ç« "
```

---

## 6. é›†æˆç‚¹

### 6.1 å¼‚æ­¥å¤„ç†å™¨é›†æˆ

**æ–‡ä»¶**: `backend/app/services/async_analysis_processor.py`

```python
async def _process_single_task(self, pending_id: int):
    # ... æ‰§è¡Œå¢å¼ºåˆ†æ ...
    
    if result:
        # ä¿å­˜ç»“æœ
        pending.status = 'completed'
        await db.commit()
        
        # âœ… è®°å½•å‰§æƒ…æŒ‡æ ‡
        await self._record_story_metrics(db, pending, result)
        
        # âœ… è¯„ä¼°è‡ªåŠ¨åˆ†å·
        await self._evaluate_volume_split(db, pending)
```

### 6.2 åŒæ­¥æ¨¡å¼é›†æˆï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `backend/app/services/auto_generator_service.py`

```python
@classmethod
async def _process_enhanced_mode(cls, ...):
    # ... å¢å¼ºåˆ†æ ...
    
    # å¦‚æœæ˜¯åŒæ­¥æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨
    from .story_metrics_service import StoryMetricsService
    from .volume_split_service import VolumeSplitService
    
    await StoryMetricsService.record_metrics(...)
    await VolumeSplitService(db, llm_service).evaluate_project(...)
```

---

## 7. é…ç½®è¯´æ˜

### é…ç½®ä½ç½®

`generation_config` ä¸­æ·»åŠ  `volume_split` èŠ‚ç‚¹ï¼š

```json
{
  "volume_split": {
    "enabled": true,
    "min_chapters": 15,
    "max_chapters": 30,
    "window_size": 5,
    "score_threshold": 60,
    "cooldown_chapters": 3,
    "naming_model": "deepseek-chat",
    "naming_timeout": 30,
    "fallback_naming": true,
    "metrics_weights": {
      "key_event": 8,
      "foreshadow": 5,
      "foreshadow_conf": 10,
      "character_breakthrough": 20,
      "world_shock": 15,
      "major_event": 25,
      "climax_multiplier": 1.2
    }
  }
}
```

### é…ç½®å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enabled` | boolean | true | æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆ†å· |
| `min_chapters` | int | 15 | æœ€å°‘ç« èŠ‚æ•°ï¼ˆä½äºæ­¤å€¼ä¸åˆ†å·ï¼‰ |
| `max_chapters` | int | 30 | æœ€å¤šç« èŠ‚æ•°ï¼ˆè¾¾åˆ°å¼ºåˆ¶åˆ†å·ï¼‰ |
| `window_size` | int | 5 | è¯„åˆ†çª—å£å¤§å°ï¼ˆæœ€è¿‘Nç« ï¼‰ |
| `score_threshold` | int | 60 | å¹³å‡è¯„åˆ†é˜ˆå€¼ |
| `cooldown_chapters` | int | 3 | å†·å´ç« èŠ‚æ•°ï¼ˆé˜²æŠ–ï¼‰ |
| `naming_model` | string | "deepseek-chat" | AIå‘½åä½¿ç”¨çš„æ¨¡å‹ |
| `naming_timeout` | int | 30 | AIå‘½åè¶…æ—¶ï¼ˆç§’ï¼‰ |
| `fallback_naming` | boolean | true | AIå¤±è´¥æ—¶ä½¿ç”¨fallback |
| `metrics_weights` | object | {...} | æŒ‡æ ‡æƒé‡é…ç½® |

---

## 8. æµ‹è¯•éªŒè¯

### 8.1 å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `backend/tests/test_story_metrics.py`

```python
async def test_metrics_calculation():
    """æµ‹è¯•æŒ‡æ ‡è®¡ç®—"""
    metrics = StoryMetricsService._extract_metrics(
        enhanced_result={
            "foreshadowings": [{"type": "climax", "confidence": 0.9}],
            "character_changes": [{"growth_level": 6}],
            "world_extensions": {"magic_system": ["æ–°æ³•æœ¯"]}
        },
        summary_result={"key_events": ["äº‹ä»¶1", "äº‹ä»¶2"]},
        word_count=3000
    )
    
    assert metrics["key_event_count"] == 2
    assert metrics["major_event_flag"] == True
    assert metrics["character_breakthrough_flag"] == True
```

**æ–‡ä»¶**: `backend/tests/test_volume_split.py`

```python
async def test_volume_split_trigger():
    """æµ‹è¯•åˆ†å·è§¦å‘"""
    # æ¨¡æ‹Ÿ15ç« ç”Ÿæˆï¼Œå…¶ä¸­3ç« é«˜åˆ†
    # éªŒè¯è‡ªåŠ¨åˆ›å»ºæ–°å·
    # éªŒè¯å·åæ ¼å¼æ­£ç¡®
    # éªŒè¯chapter.volume_idå·²æ›´æ–°
```

### 8.2 é›†æˆæµ‹è¯•

**åœºæ™¯1**: æ­£å¸¸åˆ†å·
- ç”Ÿæˆ20ç« ï¼Œå…¶ä¸­ç¬¬18-20ç« è¯„åˆ†é«˜
- éªŒè¯åœ¨ç¬¬20ç« åè‡ªåŠ¨åˆ†å·
- éªŒè¯å·åç”±AIç”Ÿæˆ

**åœºæ™¯2**: å¼ºåˆ¶åˆ†å·
- ç”Ÿæˆ30ç« ï¼Œè¯„åˆ†å‡ä½
- éªŒè¯è¾¾åˆ°max_chaptersæ—¶å¼ºåˆ¶åˆ†å·

**åœºæ™¯3**: å†·å´æœŸ
- ç¬¬15ç« åˆ†å·åï¼Œç¬¬18ç« å†æ¬¡é«˜åˆ†
- éªŒè¯ä¸ä¼šç«‹å³åˆ†å·ï¼ˆå†·å´æœŸ3ç« ï¼‰

**åœºæ™¯4**: AIå¤±è´¥fallback
- æ¨¡æ‹ŸAIè¶…æ—¶
- éªŒè¯ä½¿ç”¨fallbackå·å

---

## 9. æ”¹è¿›ç‚¹æ€»ç»“

ç›¸æ¯”åŸæ–¹æ¡ˆï¼Œæœ¬æ”¹è¿›ç‰ˆçš„ä¼˜åŠ¿ï¼š

### âœ… æ¶æ„æ”¹è¿›

1. **çº³å…¥AIåŠŸèƒ½åˆ†ç±»ä½“ç³»** - ä½œä¸ºæ–°çš„AIåŠŸèƒ½ç±»å‹ï¼ˆå‰§æƒ…æŒ‡æ ‡åˆ†æ + å·åç”Ÿæˆï¼‰
2. **æ›´å®Œå–„çš„è¯„åˆ†ç®—æ³•** - å¢åŠ é«˜æ½®è¯„åˆ†ã€å¤šç»´åº¦åŠ æƒ
3. **æ›´çµæ´»çš„è§¦å‘æ¡ä»¶** - ä¸‰ç§è§¦å‘æ–¹å¼ï¼ˆå¹³å‡åˆ†/é‡å¤§äº‹ä»¶/å•ç« é«˜æ½®ï¼‰
4. **æ›´å¼ºçš„é˜²æŠ–æœºåˆ¶** - cooldown_chapters + æœ€å°ç« èŠ‚æ•°åŒé‡ä¿æŠ¤

### âœ… åŠŸèƒ½å¢å¼º

1. **å¼ºåˆ¶åˆ†å·** - è¾¾åˆ°max_chaptersæ—¶å¼ºåˆ¶åˆ†å·ï¼Œé¿å…å·è¿‡é•¿
2. **æƒé‡å¯é…ç½®** - metrics_weightså¯åœ¨generation_configä¸­è¦†ç›–
3. **æ›´æ™ºèƒ½çš„å·å** - AIæç¤ºè¯åŒ…å«é‡å¤§äº‹ä»¶æ‘˜è¦
4. **æ›´å¥½çš„é™çº§ç­–ç•¥** - AIå¤±è´¥æ—¶æœ‰æ¸…æ™°çš„fallback

### âœ… å·¥ç¨‹è´¨é‡

1. **å®Œæ•´çš„é”™è¯¯å¤„ç†** - æ‰€æœ‰å¼‚å¸¸éƒ½ä¸é˜»å¡ä¸»æµç¨‹
2. **è¯¦ç»†çš„æ—¥å¿—è®°å½•** - æ¯ä¸ªå…³é”®æ­¥éª¤éƒ½æœ‰æ—¥å¿—
3. **æ•°æ®åº“å…¼å®¹æ€§** - æ”¯æŒPostgreSQLå’ŒSQLite
4. **æµ‹è¯•è¦†ç›–** - å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•

---

## 10. éƒ¨ç½²æ­¥éª¤

### 10.1 æ•°æ®åº“è¿ç§»

```bash
cd backend
mysql -u root -p your_database < migrations/add_story_metrics_table.sql
```

### 10.2 æ›´æ–°æ¨¡å‹å¯¼å‡º

```python
# backend/app/models/__init__.py
from .story_metrics import ChapterStoryMetrics
```

### 10.3 é…ç½®é¡¹ç›®

åœ¨é¡¹ç›®çš„ `generation_config` ä¸­æ·»åŠ  `volume_split` é…ç½®ã€‚

### 10.4 é‡å¯æœåŠ¡

```bash
# é‡å¯åå°å¤„ç†å™¨
sudo systemctl restart async-processor

# é‡å¯APIæœåŠ¡
sudo systemctl restart arboris-api
```

---

## 11. ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹PrometheusæŒ‡æ ‡ï¼š

```python
# backend/app/utils/metrics.py

volume_split_total = Counter(
    'volume_split_total',
    'Total volume splits',
    ['project_id', 'reason']
)

volume_naming_duration = Histogram(
    'volume_naming_duration_seconds',
    'Volume naming duration',
    ['model', 'success']
)
```

---

**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…æµ‹è¯•  
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

