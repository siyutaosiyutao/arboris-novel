# AIè·¯ç”±ç³»ç»Ÿ - å…¨é¢ä»£ç å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025-10-30  
**å®¡æŸ¥èŒƒå›´**: AIè·¯ç”±ç³»ç»Ÿå®Œæ•´ä»£ç   
**å®¡æŸ¥äºº**: AI Assistant

---

## ğŸ“Š æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ¶æ„å’Œè®¾è®¡** | â­â­â­â­â˜† (4/5) | åˆ†å±‚æ¸…æ™°ï¼Œè®¾è®¡æ¨¡å¼åˆç† |
| **æ•°æ®åº“å±‚** | â­â­â­â˜†â˜† (3/5) | è¡¨è®¾è®¡åˆç†ï¼Œä½†ç¼ºå°‘çº¦æŸå’Œæ¸…ç†ç­–ç•¥ |
| **ä¸šåŠ¡é€»è¾‘** | â­â­â­â­â˜† (4/5) | é‡è¯•å’Œfallbackå®Œå–„ï¼Œä½†æœ‰èµ„æºæ³„æ¼é£é™© |
| **APIå±‚** | â­â­â­â˜†â˜† (3/5) | RESTfulè®¾è®¡ï¼Œä½†ç¼ºå°‘æƒé™æ§åˆ¶ |
| **æ€§èƒ½å’Œå¯é æ€§** | â­â­â­â˜†â˜† (3/5) | æœ‰N+1æŸ¥è¯¢å’Œå¹¶å‘é—®é¢˜ |
| **å®‰å…¨æ€§** | â­â­â˜†â˜†â˜† (2/5) | ğŸ”´ **ä¸¥é‡é—®é¢˜**ï¼šç¼ºå°‘æƒé™æ§åˆ¶å’Œè¾“å…¥éªŒè¯ |
| **æµ‹è¯•å’Œæ–‡æ¡£** | â­â­â­â­â˜† (4/5) | æ–‡æ¡£å®Œæ•´ï¼Œä½†ç¼ºå°‘å•å…ƒæµ‹è¯• |

**æ€»ä½“è¯„åˆ†**: â­â­â­â˜†â˜† (3.3/5)

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. å®‰å…¨æ€§ - ç¼ºå°‘æƒé™æ§åˆ¶

**ä½ç½®**: `backend/app/api/routers/ai_routing.py:183-195`

**é—®é¢˜**:
```python
@router.patch("/routes/{function_type}")
async def update_route(...):
    # TODO: æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥  # âŒ åªæœ‰TODOï¼Œæ²¡æœ‰å®ç°
```

**å½±å“**: ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥ä¿®æ”¹AIè·¯ç”±é…ç½®

**ä¿®å¤å»ºè®®**:
```python
from ...core.deps import require_admin

@router.patch("/routes/{function_type}")
async def update_route(
    ...,
    current_user: User = Depends(require_admin),  # âœ… æ·»åŠ ç®¡ç†å‘˜æ£€æŸ¥
):
```

---

### 2. èµ„æºæ³„æ¼ - PrometheusæŒ‡æ ‡æœªæ­£ç¡®æ¸…ç†

**ä½ç½®**: `backend/app/services/ai_orchestrator.py:119`

**é—®é¢˜**:
```python
ai_calls_in_progress.labels(function=function.value).inc()  # Line 119

# å¦‚æœåœ¨ä¸­é—´æŠ›å‡ºå¼‚å¸¸ï¼Œå¯èƒ½ä¸ä¼šæ‰§è¡Œ dec()
```

**å½±å“**: æŒ‡æ ‡è®¡æ•°é”™è¯¯ï¼Œç›‘æ§æ•°æ®ä¸å‡†ç¡®

**ä¿®å¤å»ºè®®**:
```python
async def execute(...):
    ai_calls_in_progress.labels(function=function.value).inc()
    try:
        # ... æ‰§è¡Œé€»è¾‘
    finally:
        ai_calls_in_progress.labels(function=function.value).dec()
```

---

### 3. äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°

**ä½ç½®**: `backend/app/services/ai_orchestrator.py:361-365`

**é—®é¢˜**:
```python
async def _log_call(...):
    log = AIFunctionCallLog(...)
    await self.log_repo.create(log)
    await self.db_session.commit()  # âŒ åœ¨å†…éƒ¨commit
```

**å½±å“**: 
- å¯èƒ½ä¸å¤–éƒ¨äº‹åŠ¡å†²çª
- æ— æ³•å›æ»šæ•´ä¸ªæ“ä½œ

**ä¿®å¤å»ºè®®**:
```python
async def _log_call(...):
    log = AIFunctionCallLog(...)
    await self.log_repo.create(log)
    # âœ… ä¸è¦åœ¨è¿™é‡Œcommitï¼Œè®©è°ƒç”¨è€…æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
```

---

### 4. ç¼ºå°‘è¾“å…¥éªŒè¯

**ä½ç½®**: `backend/app/api/routers/ai_routing.py:207-218`

**é—®é¢˜**:
```python
if request.temperature is not None:
    route.temperature = request.temperature  # âŒ æ²¡æœ‰éªŒè¯èŒƒå›´
if request.timeout_seconds is not None:
    route.timeout_seconds = request.timeout_seconds  # âŒ æ²¡æœ‰éªŒè¯æœ€å°å€¼
```

**å½±å“**: å¯èƒ½è®¾ç½®æ— æ•ˆçš„é…ç½®å€¼

**ä¿®å¤å»ºè®®**:
```python
from pydantic import Field, validator

class UpdateRouteRequest(BaseModel):
    temperature: Optional[float] = Field(None, ge=0.0, le=2.0)
    timeout_seconds: Optional[int] = Field(None, ge=1, le=3600)
    max_retries: Optional[int] = Field(None, ge=0, le=10)
```

---

### 5. æ•æ„Ÿä¿¡æ¯æš´éœ²

**ä½ç½®**: `backend/app/api/routers/ai_routing.py:30-40`

**é—®é¢˜**:
```python
class AIProviderSchema(BaseModel):
    base_url: str  # âŒ æš´éœ²å†…éƒ¨APIåœ°å€
    cost_per_1k_tokens: Optional[float]  # âŒ æš´éœ²æˆæœ¬ä¿¡æ¯
```

**å½±å“**: æ³„éœ²å†…éƒ¨æ¶æ„å’Œå•†ä¸šä¿¡æ¯

**ä¿®å¤å»ºè®®**:
```python
class AIProviderSchema(BaseModel):
    id: int
    name: str
    display_name: str
    status: str
    # âœ… ç§»é™¤æ•æ„Ÿå­—æ®µï¼Œæˆ–åˆ›å»ºAdminProviderSchema
```

---

## âš ï¸ é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 6. N+1æŸ¥è¯¢é—®é¢˜

**ä½ç½®**: APIå±‚æŸ¥è¯¢è·¯ç”±æ—¶

**é—®é¢˜**:
```python
routes = await repo.get_all_enabled()
for route in routes:
    provider = await provider_repo.get_by_id(route.primary_provider_id)  # âŒ N+1
```

**ä¿®å¤å»ºè®®**:
```python
from sqlalchemy.orm import selectinload

result = await session.execute(
    select(AIFunctionRoute)
    .options(selectinload(AIFunctionRoute.primary_provider))
    .where(AIFunctionRoute.enabled == True)
)
```

---

### 7. ç¼ºå°‘å¹¶å‘æ§åˆ¶

**ä½ç½®**: `backend/app/api/routers/ai_routing.py:220-224`

**é—®é¢˜**:
```python
route.version += 1  # âŒ å¦‚æœä¸¤ä¸ªè¯·æ±‚åŒæ—¶æ›´æ–°ï¼Œä¼šä¸¢å¤±ä¸€ä¸ª
await session.commit()
```

**ä¿®å¤å»ºè®®**:
```python
# ä½¿ç”¨ä¹è§‚é”
result = await session.execute(
    update(AIFunctionRoute)
    .where(
        and_(
            AIFunctionRoute.id == route.id,
            AIFunctionRoute.version == old_version
        )
    )
    .values(version=old_version + 1, ...)
)
if result.rowcount == 0:
    raise HTTPException(409, "é…ç½®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•")
```

---

### 8. æ—¥å¿—è¡¨æ— é™å¢é•¿

**ä½ç½®**: `backend/migrations/add_ai_routing_tables.sql:68-109`

**é—®é¢˜**:
```sql
CREATE TABLE ai_function_call_logs (
    -- æ²¡æœ‰åˆ†åŒºæˆ–æ¸…ç†ç­–ç•¥
);
```

**ä¿®å¤å»ºè®®**:
```python
# æ·»åŠ å®šæœŸæ¸…ç†ä»»åŠ¡
async def cleanup_old_logs():
    """æ¸…ç†30å¤©å‰çš„æ—¥å¿—"""
    cutoff_date = datetime.now() - timedelta(days=30)
    await session.execute(
        delete(AIFunctionCallLog)
        .where(AIFunctionCallLog.created_at < cutoff_date)
    )
```

---

### 9. ç¼ºå°‘é€Ÿç‡é™åˆ¶

**ä½ç½®**: æ‰€æœ‰APIç«¯ç‚¹

**é—®é¢˜**:
```python
@router.get("/logs")
async def list_logs(...):
    # âŒ æ²¡æœ‰é€Ÿç‡é™åˆ¶
```

**ä¿®å¤å»ºè®®**:
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.get("/logs")
@limiter.limit("10/minute")
async def list_logs(...):
```

---

### 10. API Keyç¡¬ç¼–ç é€»è¾‘

**ä½ç½®**: `backend/app/services/llm_service.py:92-94`

**é—®é¢˜**:
```python
if provider == "openai":  # âŒ ç¡¬ç¼–ç ç‰¹æ®Šå¤„ç†
    api_key = await self._get_config_value("llm.api_key")
```

**ä¿®å¤å»ºè®®**:
```python
# ç»Ÿä¸€å¤„ç†æ‰€æœ‰provider
api_key = os.getenv(env_key)
if not api_key:
    # å°è¯•ä»æ•°æ®åº“è·å–
    provider_obj = await provider_repo.get_by_name(provider)
    if provider_obj and provider_obj.api_key:
        api_key = provider_obj.api_key
```

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### 11. æ·»åŠ ç¼“å­˜

```python
from functools import lru_cache
from cachetools import TTLCache

# ç¼“å­˜é…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰
config_cache = TTLCache(maxsize=100, ttl=300)

async def get_route_config(function_type: str):
    if function_type in config_cache:
        return config_cache[function_type]
    
    route = await repo.get_by_function_type(function_type)
    config_cache[function_type] = route
    return route
```

---

### 12. æ·»åŠ æ€»è¶…æ—¶ä¿æŠ¤

```python
async def execute(...):
    # æ·»åŠ æ€»è¶…æ—¶æ—¶é—´
    total_timeout = config.timeout * (1 + len(config.fallbacks)) * config.max_retries
    
    async with asyncio.timeout(total_timeout):
        # ... æ‰§è¡Œé€»è¾‘
```

---

### 13. åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯

```python
RETRYABLE_ERRORS = {
    "timeout", "network_error", "rate_limit"
}

NON_RETRYABLE_ERRORS = {
    "auth_error", "invalid_request"
}

if error_type in NON_RETRYABLE_ERRORS:
    break  # ä¸é‡è¯•ï¼Œç›´æ¥å°è¯•ä¸‹ä¸€ä¸ªprovider
```

---

### 14. æ·»åŠ å®¡è®¡æ—¥å¿—

```python
async def update_route(...):
    # è®°å½•å˜æ›´å†å²
    history = AIConfigHistory(
        table_name="ai_function_routes",
        record_id=route.id,
        action="update",
        old_value=json.dumps(old_values),
        new_value=json.dumps(new_values),
        changed_by=current_user.id,
        change_reason=request.reason,
    )
    await session.add(history)
```

---

### 15. æ·»åŠ å•å…ƒæµ‹è¯•

```python
# tests/test_ai_orchestrator.py
import pytest

@pytest.mark.asyncio
async def test_orchestrator_fallback():
    """æµ‹è¯•fallbackæœºåˆ¶"""
    # Mockä¸»æ¨¡å‹å¤±è´¥
    # éªŒè¯è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹
    
@pytest.mark.asyncio
async def test_orchestrator_retry():
    """æµ‹è¯•é‡è¯•æœºåˆ¶"""
    # Mockä¸´æ—¶å¤±è´¥
    # éªŒè¯é‡è¯•é€»è¾‘
```

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ P0 - ç«‹å³ä¿®å¤ï¼ˆå®‰å…¨å’Œç¨³å®šæ€§ï¼‰

1. âœ… æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
2. âœ… ä¿®å¤èµ„æºæ³„æ¼ï¼ˆPrometheusæŒ‡æ ‡ï¼‰
3. âœ… ä¿®å¤äº‹åŠ¡è¾¹ç•Œé—®é¢˜
4. âœ… æ·»åŠ è¾“å…¥éªŒè¯
5. âœ… ç§»é™¤æ•æ„Ÿä¿¡æ¯æš´éœ²

### ğŸŸ¡ P1 - æœ¬å‘¨ä¿®å¤ï¼ˆæ€§èƒ½å’Œå¯é æ€§ï¼‰

6. âœ… ä¿®å¤N+1æŸ¥è¯¢
7. âœ… æ·»åŠ å¹¶å‘æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰
8. âœ… æ·»åŠ æ—¥å¿—æ¸…ç†ç­–ç•¥
9. âœ… æ·»åŠ é€Ÿç‡é™åˆ¶
10. âœ… ç»Ÿä¸€API Keyå¤„ç†é€»è¾‘

### ğŸŸ¢ P2 - æœ¬æœˆæ”¹è¿›ï¼ˆä¼˜åŒ–ï¼‰

11. æ·»åŠ é…ç½®ç¼“å­˜
12. æ·»åŠ æ€»è¶…æ—¶ä¿æŠ¤
13. åŒºåˆ†å¯é‡è¯•é”™è¯¯
14. æ·»åŠ å®¡è®¡æ—¥å¿—
15. æ·»åŠ å•å…ƒæµ‹è¯•

---

## ğŸ¯ æ€»ç»“

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **æ¶æ„æ¸…æ™°**: åˆ†å±‚åˆç†ï¼ŒèŒè´£åˆ†ç¦»
2. **åŠŸèƒ½å®Œæ•´**: è·¯ç”±ã€fallbackã€é‡è¯•ã€ç›‘æ§éƒ½æœ‰
3. **æ–‡æ¡£è¯¦ç»†**: 5ä¸ªæ–‡æ¡£ï¼Œæ³¨é‡Šæ¸…æ™°
4. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°providerå’ŒåŠŸèƒ½

### âŒ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **å®‰å…¨æ€§**: ç¼ºå°‘æƒé™æ§åˆ¶å’Œè¾“å…¥éªŒè¯
2. **å¯é æ€§**: æœ‰èµ„æºæ³„æ¼å’Œäº‹åŠ¡é—®é¢˜
3. **æ€§èƒ½**: æœ‰N+1æŸ¥è¯¢å’Œå¹¶å‘é—®é¢˜
4. **æµ‹è¯•**: ç¼ºå°‘å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### ğŸ“ˆ å»ºè®®çš„æ”¹è¿›è·¯å¾„

**ç¬¬1å‘¨**: ä¿®å¤P0é—®é¢˜ï¼ˆå®‰å…¨å’Œç¨³å®šæ€§ï¼‰  
**ç¬¬2å‘¨**: ä¿®å¤P1é—®é¢˜ï¼ˆæ€§èƒ½å’Œå¯é æ€§ï¼‰  
**ç¬¬3å‘¨**: å®æ–½P2æ”¹è¿›ï¼ˆä¼˜åŒ–ï¼‰  
**ç¬¬4å‘¨**: æ·»åŠ æµ‹è¯•å’Œç›‘æ§

---

**å®¡æŸ¥ç»“è®º**: ç³»ç»Ÿæ•´ä½“è®¾è®¡è‰¯å¥½ï¼Œä½†åœ¨å®‰å…¨æ€§å’Œå¯é æ€§æ–¹é¢éœ€è¦åŠ å¼ºã€‚å»ºè®®ä¼˜å…ˆä¿®å¤P0å’ŒP1é—®é¢˜åå†ä¸Šçº¿ç”Ÿäº§ç¯å¢ƒã€‚

**å®¡æŸ¥äºº**: AI Assistant  
**å®¡æŸ¥æ—¥æœŸ**: 2025-10-30

