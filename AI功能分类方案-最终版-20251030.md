# ğŸ¤– AIåŠŸèƒ½åˆ†ç±»æ–¹æ¡ˆ - æœ€ç»ˆç‰ˆ

**æ—¥æœŸ**: 2025-10-30  
**åŸåˆ™**: æŒ‰ç…§"åŒä¸€æ¬¡AIè°ƒç”¨ = åŒä¸€ä¸ªåŠŸèƒ½"çš„åŸåˆ™è¿›è¡Œåˆ†ç±»  
**ç›®çš„**: ç²¾ç¡®è¯†åˆ«æ¯ä¸ªç‹¬ç«‹çš„AIè°ƒç”¨ç‚¹,ä¾¿äºç‹¬ç«‹é…ç½®ã€ç›‘æ§å’Œä¼˜åŒ–

---

## ğŸ“Š AIåŠŸèƒ½å…¨æ™¯å›¾ï¼ˆæŒ‰å®é™…è°ƒç”¨åˆ†ç±»ï¼‰

### 1ï¸âƒ£ **æ¦‚å¿µå¯¹è¯ç”Ÿæˆï¼ˆConcept Conversationï¼‰**
**è°ƒç”¨ä½ç½®**: `novels.py::converse_with_concept()`  
**æç¤ºè¯**: `concept.md`  
**è°ƒç”¨æ–¹å¼**: 
```python
llm_service.get_llm_response(
    system_prompt=concept_prompt,
    conversation_history=[...å¤šè½®å¯¹è¯å†å²...],
    temperature=0.8,
    timeout=240.0
)
```

**è¾“å…¥**: 
- ç”¨æˆ·å¤šè½®å¯¹è¯å†å²
- ç”¨æˆ·å½“å‰è¾“å…¥

**è¾“å‡º**: JSONæ ¼å¼çš„å¯¹è¯å“åº”ï¼ˆåŒ…å«é—®é¢˜ã€å»ºè®®ã€å·²æ”¶é›†ä¿¡æ¯ï¼‰

**ç‰¹ç‚¹**:
- å¤šè½®å¯¹è¯å¼äº¤äº’
- å¼•å¯¼ç”¨æˆ·å®Œå–„åˆ›æ„
- é«˜åˆ›é€ æ€§ï¼ˆtemperature=0.8ï¼‰
- ä¸ç›´æ¥ç”Ÿæˆè“å›¾

---

### 2ï¸âƒ£ **è“å›¾ç”Ÿæˆï¼ˆBlueprint Generationï¼‰**
**è°ƒç”¨ä½ç½®**: `novels.py::generate_blueprint()`  
**æç¤ºè¯**: `screenwriting.md`  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_llm_response(
    system_prompt=screenwriting_prompt,
    conversation_history=[...å®Œæ•´å¯¹è¯å†å²...],
    temperature=0.3,
    timeout=300.0
)
```

**è¾“å…¥**: 
- å®Œæ•´çš„æ¦‚å¿µå¯¹è¯å†å²

**è¾“å‡º**: å®Œæ•´çš„Blueprint JSONï¼ˆæ ‡é¢˜ã€é£æ ¼ã€ä¸–ç•Œè§‚ã€è§’è‰²ã€å¤§çº²ï¼‰

**ç‰¹ç‚¹**:
- ä¸€æ¬¡æ€§ç”Ÿæˆå®Œæ•´è®¾å®š
- åŸºäºå¯¹è¯å†å²æ•´ç†
- è¾ƒä½temperatureï¼ˆ0.3ï¼‰ç¡®ä¿ç»“æ„åŒ–
- ç”Ÿæˆåå†™å…¥æ•°æ®åº“

---

### 3ï¸âƒ£ **æ‰¹é‡å¤§çº²ç”Ÿæˆï¼ˆOutline Batch Generationï¼‰**
**è°ƒç”¨ä½ç½®**: 
- `writer.py::generate_outlines()`
- `auto_generator_service._auto_generate_outlines()`

**æç¤ºè¯**: `outline.md`  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_llm_response(
    system_prompt=outline_prompt,
    conversation_history=[{"role": "user", "content": json.dumps(payload)}],
    temperature=0.7,
    timeout=360.0
)
```

**è¾“å…¥**:
```json
{
  "novel_blueprint": {...},
  "completed_chapters": [...å·²å®Œæˆç« èŠ‚æ‘˜è¦...],
  "wait_to_generate": {
    "start_chapter": 1,
    "num_chapters": 10
  }
}
```

**è¾“å‡º**: 
```json
{
  "chapters": [
    {"chapter_number": 1, "title": "...", "summary": "..."},
    ...
  ]
}
```

**ç‰¹ç‚¹**:
- æ‰¹é‡ç”Ÿæˆï¼ˆé€šå¸¸10ç« ï¼‰
- å‚è€ƒå·²å®Œæˆç« èŠ‚
- ç¡®ä¿å‰§æƒ…è¿è´¯
- ä¸­ç­‰åˆ›é€ æ€§ï¼ˆtemperature=0.7ï¼‰

---

### 4ï¸âƒ£ **ç« èŠ‚æ­£æ–‡ç”Ÿæˆï¼ˆChapter Content Writingï¼‰**
**è°ƒç”¨ä½ç½®**: 
- `writer.py::generate_chapter()`
- `auto_generator_service._generate_chapter_content()`

**æç¤ºè¯**: `writing.md` æˆ– `screenwriting.md`  
**è°ƒç”¨æ–¹å¼**:
```python
# é€šå¸¸ç”Ÿæˆ2ä¸ªç‰ˆæœ¬
for idx in range(version_count):
    llm_service.get_llm_response(
        system_prompt=writer_prompt,
        conversation_history=[{"role": "user", "content": prompt_input}],
        temperature=0.9,
        timeout=600.0
    )
```

**è¾“å…¥**:
- Blueprintï¼ˆä¸–ç•Œè§‚ã€è§’è‰²ï¼‰
- ä¸Šä¸€ç« æ‘˜è¦
- ä¸Šä¸€ç« ç»“å°¾ç‰‡æ®µ
- RAGæ£€ç´¢çš„å‰§æƒ…ä¸Šä¸‹æ–‡
- RAGæ£€ç´¢çš„ç« èŠ‚æ‘˜è¦
- å½“å‰ç« èŠ‚å¤§çº²ï¼ˆæ ‡é¢˜+æ‘˜è¦+å†™ä½œè¦æ±‚ï¼‰

**è¾“å‡º**: 
```json
{
  "title": "ç« èŠ‚æ ‡é¢˜",
  "summary": "ç« èŠ‚æ‘˜è¦",
  "full_content": "å®Œæ•´æ­£æ–‡ï¼ˆ4500å­—ä»¥ä¸Šï¼‰"
}
```

**ç‰¹ç‚¹**:
- **æœ€é«˜åˆ›é€ æ€§**ï¼ˆtemperature=0.9ï¼‰
- **æœ€é•¿è¶…æ—¶**ï¼ˆ600ç§’ï¼‰
- æ”¯æŒå¤šç‰ˆæœ¬ç”Ÿæˆï¼ˆé€šå¸¸2ä¸ªï¼‰
- æ”¯æŒRAGå¢å¼º
- å¯é€‰å‰§æœ¬æ ¼å¼

---

### 5ï¸âƒ£ **ç« èŠ‚æ‘˜è¦æå–ï¼ˆSummary Extractionï¼‰**
**è°ƒç”¨ä½ç½®**: 
- `llm_service.get_summary()`
- `auto_generator_service` ä¸­è‡ªåŠ¨è°ƒç”¨

**æç¤ºè¯**: `extraction.md`  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_summary(
    chapter_content=content,
    temperature=0.15,
    timeout=180.0
)
```

**è¾“å…¥**: ç« èŠ‚å®Œæ•´æ­£æ–‡

**è¾“å‡º**: Markdownæ ¼å¼çš„ç»“æ„åŒ–æ‘˜è¦ï¼ˆ500å­—ä»¥å†…ï¼‰
```markdown
### 1. æ ¸å¿ƒæƒ…èŠ‚
...
### 2. è§’è‰²åŠ¨æ€
...
### 3. å…³é”®è¦ç´ 
...
### 4. è®¾å®šä¸ä¼ç¬”
...
```

**ç‰¹ç‚¹**:
- **æœ€ä½temperature**ï¼ˆ0.15-0.2ï¼‰
- å¿«é€Ÿæ‰§è¡Œï¼ˆ180ç§’ï¼‰
- ç»“æ„åŒ–è¾“å‡º
- ç”¨äºåç»­å¤§çº²ç”Ÿæˆå’ŒRAG

---

### 6ï¸âƒ£ **åŸºç¡€åˆ†æï¼ˆBasic Analysisï¼‰**
**è°ƒç”¨ä½ç½®**: `super_analysis_service._basic_analysis()`  
**æç¤ºè¯**: å†…åµŒåœ¨ä»£ç ä¸­  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_llm_response(
    system_prompt="ä½ æ˜¯ä¸“ä¸šçš„å°è¯´åˆ†æä¸“å®¶ã€‚",
    conversation_history=[{"role": "user", "content": prompt}],
    temperature=0.3,
    timeout=180.0
)
```

**è¾“å…¥**: ç« èŠ‚æ­£æ–‡

**è¾“å‡º**:
```json
{
  "summary": "ç« èŠ‚æ‘˜è¦",
  "key_events": ["äº‹ä»¶1", "äº‹ä»¶2", "äº‹ä»¶3"]
}
```

**ç‰¹ç‚¹**:
- **å¿…é¡»æˆåŠŸ**ï¼ˆå¤±è´¥è¿”å›é»˜è®¤å€¼ï¼‰
- ç»“æ„ç®€å•
- å¿«é€Ÿæ‰§è¡Œ
- ä¸ºå¢å¼ºåˆ†ææä¾›åŸºç¡€

---

### 7ï¸âƒ£ **å¢å¼ºåˆ†æï¼ˆEnhanced Analysisï¼‰**
**è°ƒç”¨ä½ç½®**: `super_analysis_service._enhanced_analysis()`  
**æç¤ºè¯**: å†…åµŒåœ¨ä»£ç ä¸­  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_llm_response(
    system_prompt="ä½ æ˜¯ä¸“ä¸šçš„å°è¯´åˆ†æä¸“å®¶ï¼Œæ“…é•¿è§’è‰²è¿½è¸ªå’Œä¸–ç•Œè§‚åˆ†æã€‚",
    conversation_history=[{"role": "user", "content": prompt}],
    temperature=0.3,
    timeout=600.0
)
```

**è¾“å…¥**:
- ç« èŠ‚æ­£æ–‡
- Blueprintï¼ˆç”¨äºå¯¹æ¯”ï¼‰

**è¾“å‡º**:
```json
{
  "character_changes": [
    {
      "character_name": "å¼ ä¸‰",
      "change_type": "æ€§æ ¼å˜åŒ–",
      "description": "...",
      "significance": "high"
    }
  ],
  "new_characters": [...],
  "world_extensions": {
    "new_locations": [...],
    "new_rules": [...],
    "new_factions": [...]
  },
  "foreshadowings": [
    {
      "content": "ä¼ç¬”å†…å®¹",
      "type": "å‰§æƒ…ä¼ç¬”",
      "confidence": 0.85
    }
  ],
  "emotional_arcs": [...]
}
```

**ç‰¹ç‚¹**:
- **å¯é€‰åŠŸèƒ½**ï¼ˆå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
- æ·±åº¦åˆ†æ
- é•¿è¶…æ—¶ï¼ˆ600ç§’ï¼‰
- ç”¨äºå‰§æƒ…æŒ‡æ ‡è®¡ç®—

---

### 8ï¸âƒ£ **ç« èŠ‚è¯„ä¼°ï¼ˆChapter Evaluationï¼‰**
**è°ƒç”¨ä½ç½®**: `writer.py::evaluate_chapter()`  
**æç¤ºè¯**: `evaluation.md`  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_llm_response(
    system_prompt=evaluator_prompt,
    conversation_history=[{"role": "user", "content": json.dumps(payload)}],
    temperature=0.3,
    timeout=360.0
)
```

**è¾“å…¥**:
```json
{
  "novel_blueprint": {...},
  "content_to_evaluate": {
    "chapter_number": 1,
    "versions": [
      {"version_id": 1, "content": "..."},
      {"version_id": 2, "content": "..."}
    ]
  }
}
```

**è¾“å‡º**: è¯„ä¼°æŠ¥å‘Šï¼ˆåŒ…å«å„ç‰ˆæœ¬è¯„åˆ†ã€ä¼˜ç¼ºç‚¹ã€æ¨èç‰ˆæœ¬ï¼‰

**ç‰¹ç‚¹**:
- è´¨é‡æ§åˆ¶
- å¤šç‰ˆæœ¬å¯¹æ¯”
- å®¢è§‚è¯„åˆ†
- å¯ç”¨äºè‡ªåŠ¨é€‰æ‹©æœ€ä½³ç‰ˆæœ¬

---

### 9ï¸âƒ£ **å‘é‡åµŒå…¥ï¼ˆText Embeddingï¼‰**
**è°ƒç”¨ä½ç½®**: 
- `chapter_ingest_service.ingest_chapter()` - ç« èŠ‚å…¥åº“
- `chapter_context_service.retrieve_for_generation()` - æ£€ç´¢æŸ¥è¯¢

**æç¤ºè¯**: æ— ï¼ˆéç”Ÿæˆå¼ï¼‰  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.get_embedding(
    text=chunk_text,
    user_id=user_id
)
```

**è¾“å…¥**: æ–‡æœ¬ç‰‡æ®µï¼ˆç« èŠ‚ç‰‡æ®µæˆ–æŸ¥è¯¢æ–‡æœ¬ï¼‰

**è¾“å‡º**: å‘é‡æ•°ç»„ï¼ˆfloat listï¼‰

**ç‰¹ç‚¹**:
- **éç”Ÿæˆå¼**
- ç”¨äºè¯­ä¹‰æ£€ç´¢
- æ”¯æŒå¤šæ¨¡å‹ï¼ˆOpenAI/Ollamaï¼‰
- æ”¯æŒå¤šprovider

**ä½¿ç”¨åœºæ™¯**:
1. ç« èŠ‚å…¥åº“æ—¶ï¼šä¸ºæ¯ä¸ªchunkç”Ÿæˆembedding
2. RAGæ£€ç´¢æ—¶ï¼šä¸ºæŸ¥è¯¢æ–‡æœ¬ç”Ÿæˆembedding

---

### ğŸ”Ÿ **å·åç”Ÿæˆï¼ˆVolume Namingï¼‰** ğŸ†•
**è°ƒç”¨ä½ç½®**: `volume_split_service._generate_volume_title()`  
**æç¤ºè¯**: å†…åµŒåœ¨ä»£ç ä¸­  
**è°ƒç”¨æ–¹å¼**:
```python
llm_service.run(
    task_name="volume_naming",
    prompt=prompt,
    model="deepseek-chat",
    timeout=30
)
```

**è¾“å…¥**:
- å·å·
- ç« èŠ‚èŒƒå›´
- é‡å¤§äº‹ä»¶æ‘˜è¦
- å‰§æƒ…æŒ‡æ ‡

**è¾“å‡º**: å·åï¼ˆå¦‚"å·äº”Â·æ˜Ÿé™¨ä¹‹å¤œ"ï¼‰

**ç‰¹ç‚¹**:
- åˆ›æ„æ€§é«˜
- ä¸€æ¬¡æ€§è°ƒç”¨
- æœ‰fallbackç­–ç•¥ï¼ˆAIå¤±è´¥æ—¶ç”¨é»˜è®¤æ ¼å¼ï¼‰
- å¿«é€Ÿæ‰§è¡Œï¼ˆ30ç§’ï¼‰

---

## ğŸ“ˆ åŠŸèƒ½ç»Ÿè®¡æ€»ç»“

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | Promptæ–‡ä»¶ | Temperature | Timeout | è°ƒç”¨é¢‘ç‡ | ä¼˜å…ˆçº§ |
|--------|---------|-----------|-------------|---------|---------|--------|
| F01 | æ¦‚å¿µå¯¹è¯ç”Ÿæˆ | concept.md | 0.8 | 240s | é«˜ | é‡è¦ |
| F02 | è“å›¾ç”Ÿæˆ | screenwriting.md | 0.3 | 300s | ä½ | é‡è¦ |
| F03 | æ‰¹é‡å¤§çº²ç”Ÿæˆ | outline.md | 0.7 | 360s | ä¸­ | é‡è¦ |
| F04 | ç« èŠ‚æ­£æ–‡ç”Ÿæˆ | writing.md | 0.9 | 600s | æé«˜ | æ ¸å¿ƒ |
| F05 | ç« èŠ‚æ‘˜è¦æå– | extraction.md | 0.15 | 180s | æé«˜ | æ ¸å¿ƒ |
| F06 | åŸºç¡€åˆ†æ | å†…åµŒ | 0.3 | 180s | é«˜ | æ ¸å¿ƒ |
| F07 | å¢å¼ºåˆ†æ | å†…åµŒ | 0.3 | 600s | é«˜ | å¯é€‰ |
| F08 | ç« èŠ‚è¯„ä¼° | evaluation.md | 0.3 | 360s | ä¸­ | å¯é€‰ |
| F09 | å‘é‡åµŒå…¥ | N/A | N/A | 60s | æé«˜ | é‡è¦ |
| F10 | å·åç”Ÿæˆ | å†…åµŒ | 0.7 | 30s | æä½ | å¯é€‰ |

**æ€»è®¡**: 10ä¸ªç‹¬ç«‹AIåŠŸèƒ½

---

## ğŸ¯ å…³é”®å‘ç°

### 1. æ²¡æœ‰é‡å¤è°ƒç”¨
âœ… æ¯ä¸ªåŠŸèƒ½éƒ½æ˜¯ç‹¬ç«‹çš„ä¸€æ¬¡AIè°ƒç”¨  
âœ… æ²¡æœ‰"åŒä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå¤šä¸ªç»“æœ"çš„æƒ…å†µ  
âœ… ç« èŠ‚æ­£æ–‡ç”Ÿæˆè™½ç„¶å¾ªç¯2æ¬¡,ä½†æ¯æ¬¡éƒ½æ˜¯ç‹¬ç«‹è°ƒç”¨

### 2. è°ƒç”¨é“¾è·¯æ¸…æ™°
```
ç”¨æˆ·åˆ›å»ºé¡¹ç›®
  â†’ F01: æ¦‚å¿µå¯¹è¯ï¼ˆå¤šè½®ï¼‰
  â†’ F02: è“å›¾ç”Ÿæˆï¼ˆä¸€æ¬¡ï¼‰
  â†’ F03: æ‰¹é‡å¤§çº²ç”Ÿæˆï¼ˆæ¯10ç« ä¸€æ¬¡ï¼‰
  â†’ F04: ç« èŠ‚æ­£æ–‡ç”Ÿæˆï¼ˆæ¯ç« 2æ¬¡ï¼‰
  â†’ F05: ç« èŠ‚æ‘˜è¦æå–ï¼ˆæ¯ç« 1æ¬¡ï¼‰
  â†’ F06: åŸºç¡€åˆ†æï¼ˆæ¯ç« 1æ¬¡ï¼‰
  â†’ F07: å¢å¼ºåˆ†æï¼ˆæ¯ç« 1æ¬¡ï¼Œå¯é€‰ï¼‰
  â†’ F08: ç« èŠ‚è¯„ä¼°ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
  â†’ F10: å·åç”Ÿæˆï¼ˆè‡ªåŠ¨åˆ†å·æ—¶ï¼‰
  
F09: å‘é‡åµŒå…¥ï¼ˆè´¯ç©¿å…¨æµç¨‹ï¼‰
  - ç« èŠ‚å…¥åº“æ—¶ï¼šæ¯ä¸ªchunkä¸€æ¬¡
  - RAGæ£€ç´¢æ—¶ï¼šæ¯æ¬¡æŸ¥è¯¢ä¸€æ¬¡
```

### 3. æˆæœ¬åˆ†å¸ƒ
**é«˜æˆæœ¬**ï¼ˆé•¿æ–‡æœ¬+é«˜temperatureï¼‰:
- F04: ç« èŠ‚æ­£æ–‡ç”Ÿæˆï¼ˆ600s, temp=0.9ï¼‰
- F07: å¢å¼ºåˆ†æï¼ˆ600s, å¤æ‚JSONï¼‰

**ä¸­æˆæœ¬**:
- F03: æ‰¹é‡å¤§çº²ç”Ÿæˆï¼ˆ360s, 10ç« ï¼‰
- F08: ç« èŠ‚è¯„ä¼°ï¼ˆ360s, å¤šç‰ˆæœ¬å¯¹æ¯”ï¼‰
- F02: è“å›¾ç”Ÿæˆï¼ˆ300s, å®Œæ•´è®¾å®šï¼‰

**ä½æˆæœ¬**:
- F05: ç« èŠ‚æ‘˜è¦æå–ï¼ˆ180s, temp=0.15ï¼‰
- F06: åŸºç¡€åˆ†æï¼ˆ180s, ç®€å•JSONï¼‰
- F01: æ¦‚å¿µå¯¹è¯ï¼ˆ240s, ä½†å•æ¬¡è¾“å‡ºå°‘ï¼‰
- F10: å·åç”Ÿæˆï¼ˆ30s, æçŸ­ï¼‰
- F09: å‘é‡åµŒå…¥ï¼ˆéç”Ÿæˆå¼ï¼‰

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. æŒ‰æˆæœ¬åˆ†å±‚é…ç½®æ¨¡å‹
```python
# é«˜æˆæœ¬åŠŸèƒ½ - ç”¨æœ€å¼ºæ¨¡å‹
F04_ç« èŠ‚æ­£æ–‡ç”Ÿæˆ: "gpt-4o" / "claude-3-opus"

# ä¸­æˆæœ¬åŠŸèƒ½ - ç”¨å¹³è¡¡æ¨¡å‹  
F03_å¤§çº²ç”Ÿæˆ: "deepseek-chat" / "claude-3-sonnet"
F02_è“å›¾ç”Ÿæˆ: "gpt-4o-mini" / "claude-3-sonnet"

# ä½æˆæœ¬åŠŸèƒ½ - ç”¨å¿«é€Ÿæ¨¡å‹
F05_æ‘˜è¦æå–: "gemini-1.5-flash" / "gpt-4o-mini"
F06_åŸºç¡€åˆ†æ: "gemini-1.5-flash" / "gpt-4o-mini"
F10_å·åç”Ÿæˆ: "deepseek-chat"

# å¯é€‰åŠŸèƒ½ - å¯é™çº§
F07_å¢å¼ºåˆ†æ: "gpt-4o" (å¤±è´¥å¯è·³è¿‡)
F08_ç« èŠ‚è¯„ä¼°: "claude-3-sonnet" (æ‰‹åŠ¨è§¦å‘)
```

### 2. å¼‚æ­¥æ‰§è¡Œç­–ç•¥
```python
# åŒæ­¥æ‰§è¡Œï¼ˆé˜»å¡ï¼‰
F04: ç« èŠ‚æ­£æ–‡ç”Ÿæˆ âœ…
F05: ç« èŠ‚æ‘˜è¦æå– âœ…
F06: åŸºç¡€åˆ†æ âœ…

# å¼‚æ­¥æ‰§è¡Œï¼ˆåå°ï¼‰
F07: å¢å¼ºåˆ†æ âš¡
F09: å‘é‡åµŒå…¥ï¼ˆå…¥åº“ï¼‰ âš¡
```

### 3. ç›‘æ§æŒ‡æ ‡
ä¸ºæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹è¿½è¸ª:
- è°ƒç”¨æ¬¡æ•°
- æˆåŠŸç‡
- å¹³å‡è€—æ—¶
- Tokenæ¶ˆè€—
- æˆæœ¬ä¼°ç®—
- å¤±è´¥åŸå› åˆ†ç±»

---

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. åˆ›å»ºAIåŠŸèƒ½æšä¸¾

```python
# app/schemas/ai_function.py

from enum import Enum
from typing import Optional

class AIFunctionType(str, Enum):
    """AIåŠŸèƒ½ç±»å‹æšä¸¾ï¼ˆæŒ‰å®é™…è°ƒç”¨åˆ†ç±»ï¼‰"""

    # æ¦‚å¿µä¸è§„åˆ’é˜¶æ®µ
    CONCEPT_CONVERSATION = "concept_conversation"      # F01: æ¦‚å¿µå¯¹è¯
    BLUEPRINT_GENERATION = "blueprint_generation"      # F02: è“å›¾ç”Ÿæˆ
    OUTLINE_BATCH_GENERATION = "outline_batch_generation"  # F03: æ‰¹é‡å¤§çº²ç”Ÿæˆ

    # ç« èŠ‚åˆ›ä½œé˜¶æ®µ
    CHAPTER_CONTENT_WRITING = "chapter_content_writing"  # F04: ç« èŠ‚æ­£æ–‡ç”Ÿæˆ
    SUMMARY_EXTRACTION = "summary_extraction"          # F05: ç« èŠ‚æ‘˜è¦æå–

    # åˆ†æé˜¶æ®µ
    BASIC_ANALYSIS = "basic_analysis"                  # F06: åŸºç¡€åˆ†æ
    ENHANCED_ANALYSIS = "enhanced_analysis"            # F07: å¢å¼ºåˆ†æ

    # è¯„ä¼°ä¸ä¼˜åŒ–
    CHAPTER_EVALUATION = "chapter_evaluation"          # F08: ç« èŠ‚è¯„ä¼°

    # åŸºç¡€è®¾æ–½
    TEXT_EMBEDDING = "text_embedding"                  # F09: å‘é‡åµŒå…¥

    # è‡ªåŠ¨åŒ–åŠŸèƒ½
    VOLUME_NAMING = "volume_naming"                    # F10: å·åç”Ÿæˆ


class AIFunctionPriority(str, Enum):
    """AIåŠŸèƒ½ä¼˜å…ˆçº§"""
    CRITICAL = "critical"    # æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»æˆåŠŸ
    IMPORTANT = "important"  # é‡è¦åŠŸèƒ½ï¼Œå¤±è´¥éœ€é‡è¯•
    OPTIONAL = "optional"    # å¯é€‰åŠŸèƒ½ï¼Œå¤±è´¥å¯å¿½ç•¥


class AIFunctionCategory(str, Enum):
    """AIåŠŸèƒ½åˆ†ç±»ï¼ˆç”¨äºåˆ†ç»„å±•ç¤ºï¼‰"""
    CONCEPT_PLANNING = "concept_planning"      # æ¦‚å¿µä¸è§„åˆ’
    CONTENT_CREATION = "content_creation"      # å†…å®¹åˆ›ä½œ
    ANALYSIS = "analysis"                      # åˆ†æ
    QUALITY_CONTROL = "quality_control"        # è´¨é‡æ§åˆ¶
    INFRASTRUCTURE = "infrastructure"          # åŸºç¡€è®¾æ–½
    AUTOMATION = "automation"                  # è‡ªåŠ¨åŒ–


# åŠŸèƒ½é…ç½®æ˜ å°„
AI_FUNCTION_CONFIG = {
    AIFunctionType.CONCEPT_CONVERSATION: {
        "name": "æ¦‚å¿µå¯¹è¯ç”Ÿæˆ",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "concept",
        "temperature": 0.8,
        "timeout": 240,
        "max_retries": 2,
        "recommended_model": "claude-3-opus",
        "fallback_model": "gpt-4o",
        "description": "å¼•å¯¼ç”¨æˆ·å®Œå–„å°è¯´åˆ›æ„çš„å¤šè½®å¯¹è¯",
    },
    AIFunctionType.BLUEPRINT_GENERATION: {
        "name": "è“å›¾ç”Ÿæˆ",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "screenwriting",
        "temperature": 0.3,
        "timeout": 300,
        "max_retries": 3,
        "recommended_model": "gpt-4o-mini",
        "fallback_model": "claude-3-sonnet",
        "description": "åŸºäºå¯¹è¯å†å²ç”Ÿæˆå®Œæ•´çš„å°è¯´è“å›¾",
    },
    AIFunctionType.OUTLINE_BATCH_GENERATION: {
        "name": "æ‰¹é‡å¤§çº²ç”Ÿæˆ",
        "category": AIFunctionCategory.CONCEPT_PLANNING,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": "outline",
        "temperature": 0.7,
        "timeout": 360,
        "max_retries": 3,
        "recommended_model": "deepseek-chat",
        "fallback_model": "gpt-4o-mini",
        "description": "æ‰¹é‡ç”Ÿæˆç« èŠ‚å¤§çº²ï¼ˆé€šå¸¸10ç« ï¼‰",
    },
    AIFunctionType.CHAPTER_CONTENT_WRITING: {
        "name": "ç« èŠ‚æ­£æ–‡ç”Ÿæˆ",
        "category": AIFunctionCategory.CONTENT_CREATION,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": "writing",
        "temperature": 0.9,
        "timeout": 600,
        "max_retries": 3,
        "recommended_model": "gpt-4o",
        "fallback_model": "claude-3-sonnet",
        "description": "ç”Ÿæˆç« èŠ‚å®Œæ•´æ­£æ–‡ï¼ˆ4500å­—ä»¥ä¸Šï¼‰",
        "cost_level": "high",
    },
    AIFunctionType.SUMMARY_EXTRACTION: {
        "name": "ç« èŠ‚æ‘˜è¦æå–",
        "category": AIFunctionCategory.CONTENT_CREATION,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": "extraction",
        "temperature": 0.15,
        "timeout": 180,
        "max_retries": 2,
        "recommended_model": "gemini-1.5-flash",
        "fallback_model": "gpt-4o-mini",
        "description": "æå–ç« èŠ‚ç»“æ„åŒ–æ‘˜è¦ï¼ˆ500å­—ä»¥å†…ï¼‰",
        "cost_level": "low",
    },
    AIFunctionType.BASIC_ANALYSIS: {
        "name": "åŸºç¡€åˆ†æ",
        "category": AIFunctionCategory.ANALYSIS,
        "priority": AIFunctionPriority.CRITICAL,
        "prompt_name": None,  # å†…åµŒ
        "temperature": 0.3,
        "timeout": 180,
        "max_retries": 2,
        "recommended_model": "gemini-1.5-flash",
        "fallback_model": "gpt-4o-mini",
        "description": "æå–ç« èŠ‚æ‘˜è¦å’Œå…³é”®äº‹ä»¶",
        "cost_level": "low",
    },
    AIFunctionType.ENHANCED_ANALYSIS: {
        "name": "å¢å¼ºåˆ†æ",
        "category": AIFunctionCategory.ANALYSIS,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": None,  # å†…åµŒ
        "temperature": 0.3,
        "timeout": 600,
        "max_retries": 1,
        "recommended_model": "gpt-4o",
        "fallback_model": None,  # å¤±è´¥å¯è·³è¿‡
        "description": "æ·±åº¦åˆ†æè§’è‰²ã€ä¸–ç•Œè§‚ã€ä¼ç¬”ç­‰",
        "cost_level": "high",
        "async_mode": True,
    },
    AIFunctionType.CHAPTER_EVALUATION: {
        "name": "ç« èŠ‚è¯„ä¼°",
        "category": AIFunctionCategory.QUALITY_CONTROL,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": "evaluation",
        "temperature": 0.3,
        "timeout": 360,
        "max_retries": 1,
        "recommended_model": "claude-3-sonnet",
        "fallback_model": "gpt-4o-mini",
        "description": "è¯„ä¼°ç« èŠ‚è´¨é‡å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®",
        "cost_level": "medium",
    },
    AIFunctionType.TEXT_EMBEDDING: {
        "name": "å‘é‡åµŒå…¥",
        "category": AIFunctionCategory.INFRASTRUCTURE,
        "priority": AIFunctionPriority.IMPORTANT,
        "prompt_name": None,
        "temperature": None,
        "timeout": 60,
        "max_retries": 2,
        "recommended_model": "text-embedding-3-large",
        "fallback_model": "nomic-embed-text",
        "description": "ç”Ÿæˆæ–‡æœ¬å‘é‡ç”¨äºRAGæ£€ç´¢",
        "cost_level": "low",
    },
    AIFunctionType.VOLUME_NAMING: {
        "name": "å·åç”Ÿæˆ",
        "category": AIFunctionCategory.AUTOMATION,
        "priority": AIFunctionPriority.OPTIONAL,
        "prompt_name": None,  # å†…åµŒ
        "temperature": 0.7,
        "timeout": 30,
        "max_retries": 1,
        "recommended_model": "deepseek-chat",
        "fallback_model": None,  # æœ‰é»˜è®¤å‘½åç­–ç•¥
        "description": "æ ¹æ®å‰§æƒ…é«˜æ½®ç”Ÿæˆå·å",
        "cost_level": "low",
    },
}
```

### 2. æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- AIåŠŸèƒ½é…ç½®è¡¨
CREATE TABLE ai_function_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    function_type VARCHAR(50) NOT NULL UNIQUE,
    enabled BOOLEAN DEFAULT TRUE,
    priority VARCHAR(20) NOT NULL,
    temperature FLOAT,
    timeout INTEGER,
    max_retries INTEGER,
    model_override VARCHAR(100),  -- å¯è¦†ç›–æ¨èæ¨¡å‹
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·çº§åˆ«çš„åŠŸèƒ½è®¿é—®æ§åˆ¶
CREATE TABLE user_ai_function_access (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    function_type VARCHAR(50) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    daily_quota INTEGER,  -- æ¯æ—¥é…é¢ï¼ˆNULL=æ— é™åˆ¶ï¼‰
    quota_used INTEGER DEFAULT 0,
    quota_reset_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, function_type)
);

-- AIåŠŸèƒ½è°ƒç”¨æ—¥å¿—
CREATE TABLE ai_function_call_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    function_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- success/failure/timeout
    duration_ms INTEGER,
    input_tokens INTEGER,
    output_tokens INTEGER,
    cost_usd DECIMAL(10, 6),
    model_used VARCHAR(100),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_call_logs_user_function ON ai_function_call_logs(user_id, function_type);
CREATE INDEX idx_call_logs_created_at ON ai_function_call_logs(created_at);
CREATE INDEX idx_user_access_user_function ON user_ai_function_access(user_id, function_type);
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç¡®è®¤åˆ†ç±»** - 10ä¸ªåŠŸèƒ½å·²å…¨éƒ¨è¯†åˆ«
2. âœ… **åˆ›å»ºæšä¸¾** - AIFunctionTypeæšä¸¾å·²è®¾è®¡
3. â­ï¸ **æ•°æ®åº“è¿ç§»** - åˆ›å»ºé…ç½®å’Œæ—¥å¿—è¡¨
4. â­ï¸ **ç»Ÿä¸€è°ƒç”¨æ¥å£** - åˆ›å»ºAIOrchestrator
5. â­ï¸ **ç›‘æ§æ¥å…¥** - æ·»åŠ PrometheusæŒ‡æ ‡
6. â­ï¸ **æˆæœ¬ä¼˜åŒ–** - æŒ‰åŠŸèƒ½åˆ†é…ä¸åŒæ¨¡å‹


