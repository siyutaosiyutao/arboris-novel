# åˆ†å·åŠŸèƒ½å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚,å®ç°äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦åŠŸèƒ½:

1. âœ… **æ·»åŠ æ•°æ®åº“è¿ç§»å’Œæ¨¡å‹** - æ”¯æŒåˆ†å·(Volume)åŠŸèƒ½
2. âœ… **æ›´æ–°AIç”Ÿæˆé€»è¾‘æ”¯æŒåˆ†å·** - è‡ªåŠ¨åˆ†é…ç« èŠ‚åˆ°åˆ†å·
3. âœ… **åˆ›å»ºç•ªèŒ„å°è¯´è‡ªåŠ¨å‘å¸ƒæœåŠ¡** - è‡ªåŠ¨å‘å¸ƒç« èŠ‚åˆ°ç•ªèŒ„å°è¯´

---

## ğŸ¯ ç¬¬ä¸€æ­¥:æ·»åŠ æ•°æ®åº“è¿ç§»å’Œæ¨¡å‹

### 1.1 åˆ›å»ºVolumeæ¨¡å‹

**æ–‡ä»¶**: `backend/app/models/novel.py`

æ–°å¢äº†`Volume`æ¨¡å‹ç±»:

```python
class Volume(Base):
    """åˆ†å·ä¿¡æ¯ã€‚"""
    __tablename__ = "volumes"
    
    id: Mapped[int] = mapped_column(BIGINT_PK_TYPE, primary_key=True, autoincrement=True)
    project_id: Mapped[str] = mapped_column(ForeignKey("novel_projects.id", ondelete="CASCADE"), nullable=False)
    volume_number: Mapped[int] = mapped_column(Integer, nullable=False)
    title: Mapped[str] = mapped_column(String(255), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text)
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
```

### 1.2 æ›´æ–°Chapterå’ŒChapterOutlineæ¨¡å‹

ä¸º`Chapter`å’Œ`ChapterOutline`æ¨¡å‹æ·»åŠ äº†`volume_id`å­—æ®µ:

```python
class ChapterOutline(Base):
    volume_id: Mapped[Optional[int]] = mapped_column(ForeignKey("volumes.id", ondelete="SET NULL"), nullable=True)
    volume: Mapped[Optional["Volume"]] = relationship(back_populates="outlines")

class Chapter(Base):
    volume_id: Mapped[Optional[int]] = mapped_column(ForeignKey("volumes.id", ondelete="SET NULL"), nullable=True)
    volume: Mapped[Optional["Volume"]] = relationship(back_populates="chapters")
```

### 1.3 åˆ›å»ºæ•°æ®åº“è¿ç§»

**æ–‡ä»¶**: `backend/db/migrations/001_add_volumes.sql`

è¿ç§»è„šæœ¬åŒ…å«:
- åˆ›å»º`volumes`è¡¨
- ä¸º`chapter_outlines`å’Œ`chapters`è¡¨æ·»åŠ `volume_id`å­—æ®µ
- ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºé»˜è®¤åˆ†å·
- å°†ç°æœ‰ç« èŠ‚å…³è”åˆ°é»˜è®¤åˆ†å·

### 1.4 æ›´æ–°Schema

**æ–‡ä»¶**: `backend/db/schema.sql`

æ›´æ–°äº†æ•°æ®åº“schema,åŒ…å«å®Œæ•´çš„åˆ†å·è¡¨å®šä¹‰å’Œå¤–é”®å…³ç³»ã€‚

**æ–‡ä»¶**: `backend/app/schemas/novel.py`

æ–°å¢äº†`Volume` Schemaç±»:

```python
class Volume(BaseModel):
    """åˆ†å·ä¿¡æ¯"""
    id: Optional[int] = None
    volume_number: int
    title: str
    description: Optional[str] = None
```

æ›´æ–°äº†`ChapterOutline`å’Œ`Blueprint` Schemaä»¥æ”¯æŒåˆ†å·ã€‚

---

## ğŸ¤– ç¬¬äºŒæ­¥:æ›´æ–°AIç”Ÿæˆé€»è¾‘æ”¯æŒåˆ†å·

### 2.1 æ›´æ–°NovelService

**æ–‡ä»¶**: `backend/app/services/novel_service.py`

#### æ›´æ–°`replace_blueprint`æ–¹æ³•

ç°åœ¨æ”¯æŒå¤„ç†åˆ†å·ä¿¡æ¯:

```python
# å¤„ç†åˆ†å·
await self.session.execute(delete(Volume).where(Volume.project_id == project_id))
volume_id_map = {}
for volume in blueprint.volumes:
    vol_record = Volume(
        project_id=project_id,
        volume_number=volume.volume_number,
        title=volume.title,
        description=volume.description,
    )
    self.session.add(vol_record)
    await self.session.flush()
    volume_id_map[volume.volume_number] = vol_record.id

# å¦‚æœæ²¡æœ‰åˆ†å·,åˆ›å»ºé»˜è®¤åˆ†å·
if not blueprint.volumes:
    default_volume = Volume(
        project_id=project_id,
        volume_number=1,
        title="é»˜è®¤",
        description="ç¬¬ä¸€å·",
    )
    self.session.add(default_volume)
    await self.session.flush()
    volume_id_map[1] = default_volume.id
```

#### æ›´æ–°`get_or_create_chapter`æ–¹æ³•

åˆ›å»ºç« èŠ‚æ—¶è‡ªåŠ¨åˆ†é…åˆ†å·:

```python
# æŸ¥æ‰¾å¯¹åº”çš„å¤§çº²ä»¥è·å–volume_id
outline_stmt = (
    select(ChapterOutline)
    .where(
        ChapterOutline.project_id == project_id,
        ChapterOutline.chapter_number == chapter_number,
    )
)
outline_result = await self.session.execute(outline_stmt)
outline = outline_result.scalars().first()

volume_id = outline.volume_id if outline else None

# å¦‚æœæ²¡æœ‰volume_id,è·å–æˆ–åˆ›å»ºé»˜è®¤åˆ†å·
if not volume_id:
    # ... åˆ›å»ºé»˜è®¤åˆ†å·é€»è¾‘
    volume_id = default_volume.id

chapter = Chapter(
    project_id=project_id,
    chapter_number=chapter_number,
    volume_id=volume_id
)
```

#### æ›´æ–°`_build_blueprint_schema`æ–¹æ³•

è¿”å›åˆ†å·ä¿¡æ¯:

```python
volumes=[
    VolumeSchema(
        id=volume.id,
        volume_number=volume.volume_number,
        title=volume.title,
        description=volume.description,
    )
    for volume in sorted(project.volumes, key=lambda v: v.volume_number)
],
chapter_outline=[
    ChapterOutlineSchema(
        chapter_number=outline.chapter_number,
        title=outline.title,
        summary=outline.summary or "",
        volume_id=outline.volume_id,
        volume_number=outline.volume.volume_number if outline.volume else None,
    )
    for outline in sorted(project.outlines, key=lambda o: o.chapter_number)
],
```

### 2.2 æ›´æ–°AutoGeneratorService

**æ–‡ä»¶**: `backend/app/services/auto_generator_service.py`

#### æ›´æ–°`_auto_generate_outlines`æ–¹æ³•

è‡ªåŠ¨ç”Ÿæˆå¤§çº²æ—¶åˆ†é…åˆ†å·:

```python
# è·å–æˆ–åˆ›å»ºé»˜è®¤åˆ†å·
result = await db.execute(
    select(Volume)
    .where(Volume.project_id == task.project_id)
    .order_by(Volume.volume_number.desc())
    .limit(1)
)
last_volume = result.scalar_one_or_none()

if not last_volume:
    # åˆ›å»ºé»˜è®¤åˆ†å·
    last_volume = Volume(
        project_id=task.project_id,
        volume_number=1,
        title="é»˜è®¤",
        description="ç¬¬ä¸€å·"
    )
    db.add(last_volume)
    await db.flush()

# åˆ›å»ºæ–°å¤§çº²,åˆ†é…åˆ°æœ€åä¸€ä¸ªåˆ†å·
db.add(
    ChapterOutline(
        project_id=task.project_id,
        volume_id=last_volume.id,
        chapter_number=item.get("chapter_number"),
        title=item.get("title", ""),
        summary=item.get("summary"),
    )
)
```

---

## ğŸ“¤ ç¬¬ä¸‰æ­¥:åˆ›å»ºç•ªèŒ„å°è¯´è‡ªåŠ¨å‘å¸ƒæœåŠ¡

### 3.1 FanqiePublisherService

**æ–‡ä»¶**: `backend/app/services/fanqie_publisher_service.py`

åˆ›å»ºäº†å®Œæ•´çš„ç•ªèŒ„å°è¯´è‡ªåŠ¨å‘å¸ƒæœåŠ¡,åŒ…å«ä»¥ä¸‹åŠŸèƒ½:

#### æ ¸å¿ƒåŠŸèƒ½

1. **æµè§ˆå™¨ç®¡ç†**
   - `init_browser()` - åˆå§‹åŒ–Playwrightæµè§ˆå™¨
   - `close()` - å…³é—­æµè§ˆå™¨
   - æ”¯æŒæ— å¤´æ¨¡å¼å’Œæœ‰å¤´æ¨¡å¼

2. **Cookieç®¡ç†**
   - `load_cookies()` - åŠ è½½ä¿å­˜çš„Cookie
   - `save_cookies()` - ä¿å­˜å½“å‰Cookie
   - é¿å…é‡å¤ç™»å½•

3. **ç™»å½•åŠŸèƒ½**
   - `login()` - è‡ªåŠ¨ç™»å½•ç•ªèŒ„å°è¯´
   - æ”¯æŒæ‰‹åŠ¨ç™»å½•åä¿å­˜Cookie

4. **ç« èŠ‚å‘å¸ƒ**
   - `publish_chapter()` - å‘å¸ƒå•ä¸ªç« èŠ‚
   - è‡ªåŠ¨å¡«å†™ç« èŠ‚åºå·ã€æ ‡é¢˜ã€å†…å®¹
   - è‡ªåŠ¨è¿è¡Œé£é™©æ£€æµ‹
   - è‡ªåŠ¨è¿è¡Œæ™ºèƒ½çº é”™
   - æ”¯æŒé€‰æ‹©åˆ†å·
   - æ”¯æŒAIæ ‡è®°
   - æ”¯æŒå®šæ—¶å‘å¸ƒ

5. **æ‰¹é‡å‘å¸ƒ**
   - `batch_publish_chapters()` - æ‰¹é‡å‘å¸ƒå¤šä¸ªç« èŠ‚
   - æ”¯æŒè®¾ç½®å‘å¸ƒé—´éš”

6. **åˆ†å·ç®¡ç†**
   - `create_volume()` - åˆ›å»ºæ–°åˆ†å·
   - å¤„ç†åˆ†å·åˆ›å»ºé™åˆ¶

#### å…³é”®ç‰¹æ€§

âœ… **è‡ªåŠ¨æ¸…ç†æ ‡é¢˜**: è‡ªåŠ¨å»é™¤æ ‡é¢˜ä¸­çš„"ç¬¬Xç« "å‰ç¼€

```python
# æ¸…ç†æ ‡é¢˜ä¸­çš„"ç¬¬Xç« "å‰ç¼€
clean_title = re.sub(r'^ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+ç« \s*', '', chapter_title)
```

âœ… **é£é™©æ£€æµ‹**: è‡ªåŠ¨è¿è¡Œé£é™©æ£€æµ‹å¹¶å¤„ç†ç»“æœ

```python
async def _run_risk_detection(self) -> Dict[str, Any]:
    # ç‚¹å‡»"é£é™©æç¤º"æŒ‰é’®
    await self.page.click('button:has-text("é£é™©æç¤º")')
    # ç‚¹å‡»"å¼€å¯æ£€æµ‹"
    await self.page.click('button:has-text("å¼€å¯æ£€æµ‹")')
    # è¯»å–æ£€æµ‹ç»“æœ
    result_text = await self.page.text_content('.risk-result, .detection-result')
```

âœ… **æ™ºèƒ½çº é”™**: è‡ªåŠ¨æ£€æµ‹å¹¶æ›¿æ¢é”™åˆ«å­—

```python
async def _run_error_correction(self) -> Dict[str, Any]:
    # åˆ‡æ¢åˆ°"æ™ºèƒ½çº é”™"æ ‡ç­¾
    await self.page.click('text="æ™ºèƒ½çº é”™"')
    # æ£€æŸ¥æ˜¯å¦æœ‰é”™åˆ«å­—
    error_count_elem = await self.page.query_selector('text=/æ£€æµ‹åˆ°.*å¤„é”™åˆ«å­—/')
    if error_count_elem:
        # æœ‰é”™åˆ«å­—,ç‚¹å‡»"æ›¿æ¢å…¨éƒ¨"
        await self.page.click('button:has-text("æ›¿æ¢å…¨éƒ¨")')
```

### 3.2 æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `backend/scripts/test_fanqie_publisher.py`

æä¾›äº†ä¸‰ç§æµ‹è¯•æ¨¡å¼:
1. å‘å¸ƒå•ä¸ªç« èŠ‚
2. æ‰¹é‡å‘å¸ƒç« èŠ‚
3. åˆ›å»ºåˆ†å·

### 3.3 ä½¿ç”¨æ–‡æ¡£

**æ–‡ä»¶**: `backend/docs/FANQIE_PUBLISHER.md`

è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£,åŒ…å«:
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- è¯¦ç»†åŠŸèƒ½è¯´æ˜
- é‡è¦æ³¨æ„äº‹é¡¹
- ä¸AIç”Ÿæˆç³»ç»Ÿé›†æˆç¤ºä¾‹
- è°ƒè¯•æŠ€å·§
- å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: å‘å¸ƒå•ä¸ªç« èŠ‚

```python
from app.services.fanqie_publisher_service import FanqiePublisherService

async def publish_example():
    async with FanqiePublisherService() as publisher:
        # åŠ è½½Cookie
        await publisher.load_cookies()
        
        # å¯¼èˆªåˆ°ä¹¦ç±
        await publisher.navigate_to_book("7566232657483287576")
        
        # å‘å¸ƒç« èŠ‚
        result = await publisher.publish_chapter(
            chapter_number=1,
            chapter_title="ç©¿è¶Šå¼‚ä¸–ç•Œ",  # ä¸è¦åŒ…å«"ç¬¬1ç« "
            content="ç« èŠ‚å†…å®¹...",
            volume_name="ç¬¬ä¸€å·",
            run_risk_detection=True,
            auto_correct_errors=True
        )
        
        print(result)
```

### ç¤ºä¾‹2: ä¸AIç”Ÿæˆç³»ç»Ÿé›†æˆ

```python
async def auto_publish_generated_chapters(project_id: str, db: AsyncSession):
    """è‡ªåŠ¨å‘å¸ƒAIç”Ÿæˆçš„ç« èŠ‚"""
    
    # è·å–é¡¹ç›®ä¿¡æ¯
    novel_service = NovelService(db)
    project = await novel_service.get_project_schema(project_id, user_id)
    
    # ç­›é€‰å·²ç”Ÿæˆä½†æœªå‘å¸ƒçš„ç« èŠ‚
    unpublished_chapters = [
        ch for ch in project.chapters
        if ch.generation_status == "successful" and not ch.published
    ]
    
    # å‡†å¤‡å‘å¸ƒæ•°æ®
    chapters_to_publish = []
    for ch in unpublished_chapters:
        volume_name = None
        if ch.volume_number:
            volume = next((v for v in project.blueprint.volumes if v.volume_number == ch.volume_number), None)
            if volume:
                volume_name = volume.title
        
        chapters_to_publish.append({
            "chapter_number": ch.chapter_number,
            "title": ch.title,
            "content": ch.content,
            "volume_name": volume_name
        })
    
    # å‘å¸ƒåˆ°ç•ªèŒ„å°è¯´
    async with FanqiePublisherService() as publisher:
        await publisher.load_cookies()
        await publisher.navigate_to_book("ä½ çš„ä¹¦ç±ID")
        
        results = await publisher.batch_publish_chapters(
            chapters=chapters_to_publish,
            interval_seconds=10
        )
    
    return results
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. ç« èŠ‚æ ‡é¢˜æ ¼å¼

âŒ **é”™è¯¯**: `chapter_title="ç¬¬ä¸€ç«  ç©¿è¶Šå¼‚ä¸–ç•Œ"`  
âœ… **æ­£ç¡®**: `chapter_title="ç©¿è¶Šå¼‚ä¸–ç•Œ"`

ç•ªèŒ„å°è¯´ä¼šè‡ªåŠ¨æ·»åŠ "ç¬¬Xç« "å‰ç¼€ã€‚

### 2. åˆ†å·åˆ›å»ºé™åˆ¶

- **ä¸èƒ½åˆ›å»ºå¤šä¸ªç©ºåˆ†å·**
- å¿…é¡»å…ˆåœ¨å½“å‰åˆ†å·å‘å¸ƒç« èŠ‚,æ‰èƒ½åˆ›å»ºä¸‹ä¸€ä¸ªåˆ†å·
- è¿™æ˜¯ç•ªèŒ„å°è¯´å¹³å°çš„é™åˆ¶

### 3. é£é™©æ£€æµ‹è¦æ±‚

- ç« èŠ‚å†…å®¹è‡³å°‘éœ€è¦**1000å­—**æ‰èƒ½ä½¿ç”¨é£é™©æ£€æµ‹
- å»ºè®®æ¯æ¬¡å‘å¸ƒéƒ½è¿è¡Œé£é™©æ£€æµ‹

---

## ğŸ‰ å®Œæˆæ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… **æ•°æ®åº“å±‚é¢**
- åˆ›å»º`volumes`è¡¨
- ä¸º`chapters`å’Œ`chapter_outlines`æ·»åŠ `volume_id`å­—æ®µ
- åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬

âœ… **æ¨¡å‹å±‚é¢**
- åˆ›å»º`Volume`æ¨¡å‹
- æ›´æ–°`Chapter`å’Œ`ChapterOutline`æ¨¡å‹
- æ›´æ–°Schemaæ”¯æŒåˆ†å·

âœ… **AIç”Ÿæˆå±‚é¢**
- è“å›¾ç”Ÿæˆæ”¯æŒåˆ†å·è§„åˆ’
- ç« èŠ‚å¤§çº²ç”Ÿæˆè‡ªåŠ¨åˆ†é…åˆ†å·
- è‡ªåŠ¨ç”Ÿæˆå™¨æ”¯æŒåˆ†å·

âœ… **ç•ªèŒ„å°è¯´å‘å¸ƒ**
- å®Œæ•´çš„è‡ªåŠ¨å‘å¸ƒæœåŠ¡
- æ”¯æŒé£é™©æ£€æµ‹å’Œæ™ºèƒ½çº é”™
- æ”¯æŒåˆ†å·é€‰æ‹©
- æ‰¹é‡å‘å¸ƒåŠŸèƒ½
- CookieæŒä¹…åŒ–

### ä¸‹ä¸€æ­¥å»ºè®®

1. **è¿è¡Œæ•°æ®åº“è¿ç§»**: æ‰§è¡Œ`001_add_volumes.sql`è¿ç§»è„šæœ¬
2. **æµ‹è¯•å‘å¸ƒåŠŸèƒ½**: è¿è¡Œ`test_fanqie_publisher.py`æµ‹è¯•è„šæœ¬
3. **é›†æˆåˆ°è‡ªåŠ¨ç”Ÿæˆå™¨**: åœ¨è‡ªåŠ¨ç”Ÿæˆå®Œæˆåè‡ªåŠ¨å‘å¸ƒåˆ°ç•ªèŒ„å°è¯´
4. **æ·»åŠ å‘å¸ƒçŠ¶æ€è·Ÿè¸ª**: åœ¨æ•°æ®åº“ä¸­è®°å½•ç« èŠ‚å‘å¸ƒçŠ¶æ€

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `backend/app/services/fanqie_publisher_service.py` - ç•ªèŒ„å°è¯´å‘å¸ƒæœåŠ¡
- `backend/db/migrations/001_add_volumes.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
- `backend/scripts/test_fanqie_publisher.py` - æµ‹è¯•è„šæœ¬
- `backend/docs/FANQIE_PUBLISHER.md` - ä½¿ç”¨æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- `backend/app/models/novel.py` - æ·»åŠ Volumeæ¨¡å‹
- `backend/app/schemas/novel.py` - æ·»åŠ Volume Schema
- `backend/app/services/novel_service.py` - æ”¯æŒåˆ†å·
- `backend/app/services/auto_generator_service.py` - æ”¯æŒåˆ†å·
- `backend/db/schema.sql` - æ›´æ–°æ•°æ®åº“schema

---

**å®æ–½å®Œæˆæ—¶é—´**: 2025-10-29  
**å®æ–½çŠ¶æ€**: âœ… å®Œæˆ

